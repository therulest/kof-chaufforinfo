<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin ‚Äì Nyheter</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:16px;background:#fafafa;color:#111}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.05);padding:16px;max-width:900px;margin:0 auto}
  h1{margin:0 0 12px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  input,textarea,button{font:inherit}
  input,textarea{border:1px solid #d1d5db;border-radius:8px;padding:10px;min-width:260px}
  textarea{min-height:120px;width:100%}
  button{background:#0ea5e9;color:#fff;border:none;border-radius:8px;padding:10px 14px;cursor:pointer}
  button.secondary{background:#6b7280}
  table{width:100%;border-collapse:collapse;margin-top:16px}
  th,td{border-bottom:1px solid #eee;padding:8px;text-align:left;vertical-align:top}
  .muted{color:#6b7280}
  .right{float:right}

  /* login-modal √•teranv√§nder dina ‚Äúlock‚Äù-klasser f√∂r utseende */
  .lock-overlay{position:fixed;inset:0;background:rgba(250,250,250,.96);display:flex;align-items:center;justify-content:center;z-index:9999}
  .lock-card{width:min(420px,92vw);background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.10);padding:20px}
  .lock-title{margin:0 0 8px 0;font-size:20px}
  .lock-sub{margin:0 0 16px 0;font-size:13px;color:#6b7280}
  .lock-row{display:flex;gap:8px}
  .lock-input{flex:1;border:1px solid #d1d5db;border-radius:10px;padding:10px 12px;font-size:16px}
  .lock-btn{background:#0ea5e9;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-size:15px;cursor:pointer;transition:all .2s;white-space:nowrap}
  .lock-btn:hover{background:#0284c7}
  .lock-err{margin-top:10px;color:#b00020;font-size:13px;min-height:1.2em}
</style>
</head>
<body>
<div class="card">
  <h1>Admin ‚Äì Nyheter</h1>

  <!-- Auth status + knappar -->
  <div id="auth" style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
    <button id="loginBtn">Logga in</button>
    <button id="logoutBtn" class="secondary" style="display:none">Logga ut</button>
    <span id="who" class="muted"></span>
    <button id="resetBtn" class="secondary" style="display:none">√Öterst√§ll l√∂senord</button>
  </div>

  <!-- Login-dialog (email + l√∂senord) -->
  <div id="loginModal" class="lock-overlay" style="display:none">
    <div class="lock-card">
      <h2 class="lock-title">Logga in</h2>
      <p class="lock-sub">Ange e-post och l√∂senord f√∂r administrat√∂r.</p>
      <div class="lock-row" style="flex-direction:column;gap:10px">
        <input id="emailEl" class="lock-input" type="email" placeholder="namn@exempel.se" autocomplete="username">
        <input id="passEl"  class="lock-input" type="password" placeholder="L√∂senord" autocomplete="current-password">
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="cancelLogin" class="lock-btn" style="background:#6b7280">Avbryt</button>
          <button id="doLogin" class="lock-btn">Logga in</button>
        </div>
        <div style="display:flex;justify-content:flex-end">
          <a href="#" id="forgotLink" class="muted" style="font-size:12px;text-decoration:underline">Gl√∂mt l√∂senord?</a>
        </div>
      </div>
      <div id="loginErr" class="lock-err"></div>
    </div>
  </div>

  <!-- Formul√§r -->
  <div id="form" style="display:none;margin-top:16px">
    <h3 id="formTitle">Skapa nyhet</h3>
    <div class="row">
      <input id="title" placeholder="Titel">
      <input id="date" type="date">
    </div>
    <div class="row">
      <textarea id="body" placeholder="Text ‚Ä¶"></textarea>
    </div>
    <div class="row">
      <button id="saveBtn">Spara</button>
      <button id="cancelBtn" class="secondary" style="display:none">Avbryt</button>
    </div>
  </div>

  <h3 style="margin-top:20px">Nyhetslista</h3>
  <table id="tbl">
    <thead><tr><th>Titel</th><th>Datum</th><th>Text</th><th></th></tr></thead>
    <tbody></tbody>
  </table>
  <p class="muted">Visar de senaste 100 posterna, sorterat p√• datum.</p>
</div>

<!-- üî• Firebase + Admin Script -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth, setPersistence, browserLocalPersistence,
    onAuthStateChanged, signInWithEmailAndPassword, signOut, sendPasswordResetEmail
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, updateDoc, deleteDoc,
    doc, getDocs, query, orderBy, limit
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ===== Din Firebase-konfiguration =====
  const firebaseConfig = {
    apiKey: "AIzaSyDUPTHaLl4j_Wfp4kK62uBOQSotdl0QOjc",
    authDomain: "kofnord-1e371.firebaseapp.com",
    projectId: "kofnord-1e371",
    storageBucket: "kofnord-1e371.appspot.com",
    messagingSenderId: "559491880457",
    appId: "1:559491880457:web:b57bbf0bd1bb11ac3f0ad8"
  };

  // ===== Initiera Firebase =====
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  await setPersistence(auth, browserLocalPersistence);

  // ===== Referenser till HTML-element =====
  const loginBtn    = document.getElementById('loginBtn');
  const logoutBtn   = document.getElementById('logoutBtn');
  const resetBtn    = document.getElementById('resetBtn');
  const who         = document.getElementById('who');

  const loginModal  = document.getElementById('loginModal');
  const emailEl     = document.getElementById('emailEl');
  const passEl      = document.getElementById('passEl');
  const doLogin     = document.getElementById('doLogin');
  const cancelLogin = document.getElementById('cancelLogin');
  const loginErr    = document.getElementById('loginErr');
  const forgotLink  = document.getElementById('forgotLink');

  const form      = document.getElementById('form');
  const formTitle = document.getElementById('formTitle');
  const titleEl   = document.getElementById('title');
  const dateEl    = document.getElementById('date');
  const bodyEl    = document.getElementById('body');
  const saveBtn   = document.getElementById('saveBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const tbody     = document.querySelector('#tbl tbody');

  let editId = null;

  // ===== Sm√• helpers (modal) =====
  function openLogin()  { loginModal.style.display = 'flex'; loginErr.textContent=''; }
  function closeLogin() { loginModal.style.display = 'none'; emailEl.value=''; passEl.value=''; loginErr.textContent=''; }

  // ===== Autentisering =====
  onAuthStateChanged(auth, user => {
    const isIn = !!user;
    loginBtn.style.display  = isIn ? 'none' : '';
    logoutBtn.style.display = isIn ? '' : 'none';
    resetBtn.style.display  = isIn ? '' : 'none';
    who.textContent = isIn ? `Inloggad som ${user.email}` : '';
    form.style.display = isIn ? '' : 'none';
    if(isIn) loadNews();
    else tbody.innerHTML = '';
  });

  loginBtn.addEventListener('click', openLogin);
  cancelLogin.addEventListener('click', closeLogin);

  doLogin.addEventListener('click', async () => {
    try{
      const email = emailEl.value.trim();
      const pass  = passEl.value;
      if(!email || !pass) { loginErr.textContent = 'Fyll i e-post och l√∂senord.'; return; }
      await signInWithEmailAndPassword(auth, email, pass);
      closeLogin();
    }catch(e){
      loginErr.textContent = (e.message || 'Kunde inte logga in').replace('Firebase:','').trim();
    }
  });

  logoutBtn.addEventListener('click', () => signOut(auth));

  forgotLink.addEventListener('click', async (e)=>{
    e.preventDefault();
    try{
      const email = emailEl.value.trim();
      if(!email) { loginErr.textContent = 'Skriv din e-post ovan och klicka igen.'; return; }
      await sendPasswordResetEmail(auth, email);
      loginErr.style.color = '#065f46';
      loginErr.textContent = '√Öterst√§llningsl√§nk skickad. Kolla din e-post.';
    }catch(err){
      loginErr.style.color = '#b00020';
      loginErr.textContent = (err.message || '').replace('Firebase:','').trim();
    }
  });

  resetBtn.addEventListener('click', async ()=>{
    try{
      if(!auth.currentUser?.email){ alert('Ingen inloggad e-post.'); return; }
      await sendPasswordResetEmail(auth, auth.currentUser.email);
      alert('√Öterst√§llningsl√§nk skickad till ' + auth.currentUser.email);
    }catch(err){
      alert('Kunde inte skicka √•terst√§llning: ' + (err.message || ''));
    }
  });

  // ===== CRUD =====
  async function loadNews(){
    const q = query(collection(db,'news'), orderBy('date','desc'), limit(100));
    const snap = await getDocs(q);
    tbody.innerHTML = '';
    snap.forEach(d => {
      const item = d.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(item.title || '')}</td>
        <td>${item.date || ''}</td>
        <td class="muted">${(item.body || '').substring(0,120)}${(item.body||'').length>120?'‚Ä¶':''}</td>
        <td>
          <button data-edit="${d.id}">Redigera</button>
          <button data-del="${d.id}" class="secondary">Ta bort</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => (
      {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
    ));
  }

  tbody.addEventListener('click', async (e)=>{
    const id = e.target.dataset.edit || e.target.dataset.del;
    if(!id) return;

    if(e.target.dataset.edit){
      editId = id;
      formTitle.textContent = 'Redigera nyhet';
      const tr = e.target.closest('tr');
      titleEl.value = tr.children[0].textContent;
      dateEl.value  = tr.children[1].textContent;

      // h√§mta body exakt fr√•n Firestore
      const docs = await getDocs(query(collection(db,'news'), orderBy('date','desc'), limit(100)));
      docs.forEach(d=>{ if(d.id===id){ bodyEl.value = d.data().body || ''; }});
      cancelBtn.style.display = '';
    }else if(e.target.dataset.del){
      if(confirm('Ta bort nyheten?')){
        await deleteDoc(doc(db,'news',id));
        await loadNews();
      }
    }
  });

  saveBtn.addEventListener('click', async ()=>{
    const payload = {
      title: titleEl.value.trim(),
      date:  dateEl.value,   // YYYY-MM-DD
      body:  bodyEl.value.trim()
    };
    if(!payload.title || !payload.date){
      alert('Titel och datum kr√§vs.');
      return;
    }

    if(editId){
      await updateDoc(doc(db,'news',editId), payload);
    }else{
      await addDoc(collection(db,'news'), payload);
    }

    titleEl.value = bodyEl.value = '';
    dateEl.value = '';
    editId = null;
    formTitle.textContent = 'Skapa nyhet';
    cancelBtn.style.display='none';
    await loadNews();
  });

  cancelBtn.addEventListener('click', ()=>{
    editId = null;
    formTitle.textContent = 'Skapa nyhet';
    titleEl.value = bodyEl.value = '';
    dateEl.value = '';
    cancelBtn.style.display='none';
  });
</script>
</body>
</html>
