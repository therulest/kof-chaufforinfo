<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin – Portal</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:16px;background:#fafafa;color:#111}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.05);padding:16px;max-width:1000px;margin:0 auto}
  h1{margin:0 0 12px}
  .tabs{display:flex;gap:8px;margin:6px 0 14px}
  .tab{border:1px solid #e5e7eb;background:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
  .tab.active{background:#eef6ff;border-color:#cfe3ff}
  .section[hidden]{display:none}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  input,textarea,button{font:inherit}
  input,textarea{border:1px solid #d1d5db;border-radius:8px;padding:10px;min-width:260px}
  textarea{min-height:120px;width:100%}
  button{background:#0ea5e9;color:#fff;border:none;border-radius:8px;padding:10px 14px;cursor:pointer}
  button.secondary{background:#6b7280}
  .muted{color:#6b7280}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border-bottom:1px solid #eee;padding:8px;text-align:left;vertical-align:top}
  .note{font-size:12px;color:#6b7280}
</style>
</head>
<body>
<div class="card">
  <h1>Admin – Portal</h1>

  <!-- Auth -->
  <div id="auth" class="row" style="align-items:center">
    <div>
      <button id="loginBtn">Logga in</button>
      <button id="logoutBtn" class="secondary" style="display:none">Logga ut</button>
    </div>
    <span id="who" class="muted"></span>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-tab="news">Nyheter</button>
    <button class="tab" data-tab="contacts">Kontakter</button>
    <button class="tab" data-tab="lock">Lås (PIN)</button>
  </div>

  <!-- Nyheter -->
  <section id="sec-news" class="section">
    <h3>Nyheter</h3>
    <div class="row">
      <input id="n-title" placeholder="Titel">
      <input id="n-date" type="date">
    </div>
    <div class="row"><textarea id="n-body" placeholder="Text …"></textarea></div>
    <div class="row">
      <button id="n-save">Spara</button>
      <button id="n-cancel" class="secondary" style="display:none">Avbryt</button>
    </div>

    <table id="n-table">
      <thead><tr><th>Titel</th><th>Datum</th><th>Text</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <p class="note">Visar sorterat på datum (fallande).</p>
  </section>

  <!-- Kontakter -->
  <section id="sec-contacts" class="section" hidden>
    <h3>Kontakter</h3>
    <div class="row">
      <input id="c-name"  placeholder="Namn">
      <input id="c-role"  placeholder="Roll">
      <input id="c-phone" placeholder="Telefon">
    </div>
    <div class="row">
      <input id="c-email" placeholder="E-post">
      <input id="c-sort"  placeholder="Sort (t.ex. 10)">
    </div>
    <div class="row">
      <button id="c-save">Spara</button>
      <button id="c-cancel" class="secondary" style="display:none">Avbryt</button>
    </div>

    <table id="c-table">
      <thead><tr><th>Namn</th><th>Roll</th><th>Telefon</th><th>E-post</th><th>Sort</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <p class="note">Sortering sker på “sort” (lägst först), därefter namn.</p>
  </section>

  <!-- Lås (PIN) -->
  <section id="sec-lock" class="section" hidden>
    <h3>Lås (PIN)</h3>
    <p class="note">Endast hash lagras i Firestore – aldrig själva PIN-koden.</p>
    <div class="row" style="align-items:center">
      <label><input type="checkbox" id="l-require"> Kräv PIN</label>
    </div>
    <div class="row">
      <input id="l-new" placeholder="Ny PIN (lämna tom för att inte ändra)">
      <input id="l-msg" placeholder="Meddelande på låsskärmen (valfritt)" style="min-width:360px">
    </div>
    <div class="row">
      <button id="l-save">Spara låsinställningar</button>
      <button id="l-clear" class="secondary">Rensa PIN</button>
    </div>
    <p class="note" id="l-info"></p>
  </section>
</div>

<script type="module">
  /* ===== Firebase ===== */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, updateDoc, deleteDoc, doc,
    getDocs, orderBy, query, setDoc, getDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDUPTHaLl4j_Wfp4kK62uBOQSotdl0QOjc",
    authDomain: "kofnord-1e371.firebaseapp.com",
    projectId: "kofnord-1e371",
  };

  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  const $ = s => document.querySelector(s);

  /* ===== Tabs ===== */
  const tabs=[...document.querySelectorAll('.tab')];
  function setTab(id){
    tabs.forEach(t=>t.classList.toggle('active', t.dataset.tab===id));
    $('#sec-news').hidden = id!=='news';
    $('#sec-contacts').hidden = id!=='contacts';
    $('#sec-lock').hidden = id!=='lock';
    if(id==='news') loadNews();
    if(id==='contacts') loadContacts();
    if(id==='lock') loadLock();
  }
  tabs.forEach(t=> t.addEventListener('click', ()=> setTab(t.dataset.tab)));

  /* ===== Auth (email+password) ===== */
  const loginBtn  = $('#loginBtn');
  const logoutBtn = $('#logoutBtn');
  const who       = $('#who');

  onAuthStateChanged(auth, user=>{
    const isIn=!!user;
    loginBtn.style.display = isIn?'none':'';
    logoutBtn.style.display= isIn?'':'none';
    who.textContent = isIn ? `Inloggad som ${user.email}` : '';
    if(isIn){ setTab('news'); } else { setTab('news'); } // default
  });

  loginBtn.addEventListener('click', async ()=>{
    const email = prompt('E-post:');
    if(!email) return;
    const pass  = prompt('Lösenord:');
    if(!pass) return;
    try{
      await signInWithEmailAndPassword(auth,email,pass);
    }catch(e){ alert('Inloggning misslyckades: '+e.message); }
  });
  logoutBtn.addEventListener('click', ()=> signOut(auth));

  /* ===== Nyheter (CRUD) ===== */
  const nTitle=$('#n-title'), nDate=$('#n-date'), nBody=$('#n-body');
  const nSave=$('#n-save'), nCancel=$('#n-cancel'), nTbody=$('#n-table tbody');
  let nEdit=null;

  async function loadNews(){
    if(!auth.currentUser) return;
    nTbody.innerHTML='';
    const qRef=query(collection(db,'news'), orderBy('date','desc'));
    const snap=await getDocs(qRef);
    snap.forEach(d=>{
      const it=d.data();
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${it.title||''}</td>
        <td>${it.date||''}</td>
        <td class="muted">${(it.body||'').slice(0,120)}${(it.body||'').length>120?'…':''}</td>
        <td>
          <button data-e="${d.id}">Redigera</button>
          <button class="secondary" data-d="${d.id}">Ta bort</button>
        </td>`;
      nTbody.appendChild(tr);
    });
  }
  nTbody.addEventListener('click', async e=>{
    const id=e.target.dataset.e||e.target.dataset.d;
    if(!id) return;
    if(e.target.dataset.e){
      nEdit=id; nCancel.style.display='';
      // snabb-läs från tabellen
      const tr=e.target.closest('tr');
      nTitle.value=tr.children[0].textContent;
      nDate.value=tr.children[1].textContent;
      // hämta hela body
      const snap=await getDocs(query(collection(db,'news'), orderBy('date','desc')));
      snap.forEach(d=>{ if(d.id===id) nBody.value=(d.data().body||''); });
    }else{
      if(confirm('Ta bort nyheten?')){ await deleteDoc(doc(db,'news',id)); loadNews(); }
    }
  });
  nSave.addEventListener('click', async ()=>{
    if(!auth.currentUser) return;
    const payload={ title:nTitle.value.trim(), date:nDate.value, body:nBody.value.trim() };
    if(!payload.title||!payload.date){ alert('Titel och datum krävs.'); return; }
    if(nEdit) await updateDoc(doc(db,'news',nEdit), payload);
    else      await addDoc(collection(db,'news'), payload);
    nTitle.value=nBody.value=''; nDate.value=''; nEdit=null; nCancel.style.display='none'; loadNews();
  });
  nCancel.addEventListener('click', ()=>{ nEdit=null; nTitle.value=nBody.value=''; nDate.value=''; nCancel.style.display='none'; });

  /* ===== Kontakter (CRUD) ===== */
  const cName=$('#c-name'), cRole=$('#c-role'), cPhone=$('#c-phone'), cEmail=$('#c-email'), cSort=$('#c-sort');
  const cSave=$('#c-save'), cCancel=$('#c-cancel'), cTbody=$('#c-table tbody');
  let cEdit=null;

  async function loadContacts(){
    if(!auth.currentUser) return;
    cTbody.innerHTML='';
    const snap=await getDocs(collection(db,'contacts'));
    const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()}));
    arr.sort((a,b)=>(a.sort??999)-(b.sort??999) || (a.name||'').localeCompare(b.name||''));
    arr.forEach(it=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${it.name||''}</td>
        <td>${it.role||''}</td>
        <td>${it.phone||''}</td>
        <td>${it.email||''}</td>
        <td>${it.sort??''}</td>
        <td>
          <button data-e="${it.id}">Redigera</button>
          <button class="secondary" data-d="${it.id}">Ta bort</button>
        </td>`;
      cTbody.appendChild(tr);
    });
  }
  cTbody.addEventListener('click', async e=>{
    const id=e.target.dataset.e||e.target.dataset.d;
    if(!id) return;
    if(e.target.dataset.e){
      cEdit=id; cCancel.style.display='';
      const tr=e.target.closest('tr');
      cName.value = tr.children[0].textContent;
      cRole.value = tr.children[1].textContent;
      cPhone.value= tr.children[2].textContent;
      cEmail.value= tr.children[3].textContent;
      cSort.value = tr.children[4].textContent;
    }else{
      if(confirm('Ta bort kontakten?')){ await deleteDoc(doc(db,'contacts',id)); loadContacts(); }
    }
  });
  cSave.addEventListener('click', async ()=>{
    if(!auth.currentUser) return;
    const payload={
      name:cName.value.trim(), role:cRole.value.trim(), phone:cPhone.value.trim(), email:cEmail.value.trim(),
      sort: (cSort.value||'').trim()==='' ? null : Number(cSort.value)
    };
    if(!payload.name){ alert('Namn krävs.'); return; }
    if(cEdit) await updateDoc(doc(db,'contacts',cEdit), payload);
    else      await addDoc(collection(db,'contacts'), payload);
    cName.value=cRole.value=cPhone.value=cEmail.value=cSort.value=''; cEdit=null; cCancel.style.display='none'; loadContacts();
  });
  cCancel.addEventListener('click', ()=>{ cEdit=null; cName.value=cRole.value=cPhone.value=cEmail.value=cSort.value=''; cCancel.style.display='none'; });

  /* ===== Lås (PIN) ===== */
  const lReq=$('#l-require'), lNew=$('#l-new'), lMsg=$('#l-msg'), lInfo=$('#l-info');
  async function sha256Hex(str){
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  async function loadLock(){
    if(!auth.currentUser) return;
    const snap=await getDoc(doc(db,'settings','site'));
    if(!snap.exists()){ lReq.checked=false; lMsg.value=''; lInfo.textContent='Ingen PIN konfigurerad.'; return; }
    const it=snap.data();
    lReq.checked=!!it.require_pin;
    lMsg.value=it.lock_message||'';
    lInfo.textContent=`Status: ${it.require_pin?'Kräver PIN':'Ej låst'}`;
  }
  $('#l-save').addEventListener('click', async ()=>{
    if(!auth.currentUser) return;
    const next={ require_pin: !!lReq.checked, lock_message: (lMsg.value||'').trim(), pin_updated_at: serverTimestamp() };
    const newPin=(lNew.value||'').trim();
    if(newPin){ next.pin_hash=await sha256Hex(newPin); }
    await setDoc(doc(db,'settings','site'), next, {merge:true});
    lNew.value=''; alert('Låsinställningar sparade.'); loadLock();
  });
  $('#l-clear').addEventListener('click', async ()=>{
    if(!auth.currentUser) return;
    if(!confirm('Rensa PIN och avaktivera lås?')) return;
    await setDoc(doc(db,'settings','site'), {require_pin:false, pin_hash:'', pin_updated_at:serverTimestamp()}, {merge:true});
    alert('PIN rensad.'); loadLock();
  });

  // Init
  setTab('news');
</script>
</body>
</html>

