<!doctype html>
<html>
<head>
  <!-- Om vi kom via invite/reset: flytta med token till hash -->
  <script>
    (function () {
      try {
        var saved = sessionStorage.getItem('_nl_hash');
        if (saved && !/(invite_token|confirmation_token|recovery_token)=/i.test(location.hash)) {
          sessionStorage.removeItem('_nl_hash');
          var here = location.pathname.replace(/\/index\.html?$/,'/') + saved;
          location.replace(here);
        }
      } catch(e) {}
    })();
  </script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin – Nyheter</title>
  <link rel="stylesheet" href="https://unpkg.com/decap-cms@^3/dist/decap-cms.css">
</head>
<body>
  <!-- Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3/dist/decap-cms.js"></script>
  <!-- Netlify Identity -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <script>
    // Säg åt Decap att vi initierar konfig själv (ingen fetch av /admin/config.yml)
    window.CMS_MANUAL_INIT = true;

    // Starta CMS med samma config som vi annars haft i config.yml
    document.addEventListener('DOMContentLoaded', function () {
      CMS.init({
        config: {
          backend: { name: 'git-gateway', branch: 'main' },
          media_folder: 'static/uploads',
          public_folder: '/static/uploads',
          collections: [
            {
              name: 'site',
              label: 'Webbplats',
              files: [
                {
                  name: 'news',
                  label: 'Nyheter',
                  file: 'data/news.json',
                  fields: [
                    {
                      label: 'Nyheter',
                      name: 'items',
                      widget: 'list',
                      summary: '{{fields.title}} ({{fields.date}})',
                      fields: [
                        { label: 'Titel', name: 'title', widget: 'string' },
                        { label: 'Datum', name: 'date', widget: 'datetime', format: 'YYYY-MM-DD', time_format: false },
                        { label: 'Text', name: 'body', widget: 'text' }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      });
    });

    // Identity: öppna login vid behov, stanna på /admin efter login
    if (window.netlifyIdentity) {
      window.netlifyIdentity.on('init', function (user) {
        if (!user) window.netlifyIdentity.open('login');
      });
      window.netlifyIdentity.on('login', function () {
        location.replace('/admin/');
      });
      window.netlifyIdentity.on('logout', function () {
        location.reload();
      });
    }
  </script>
</body>
</html>
