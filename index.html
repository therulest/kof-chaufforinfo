<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>KOF ‚Äì Chauff√∂rportal</title>

<style>
:root{ --border:#e5e7eb; --shadow:0 1px 3px rgba(0,0,0,.05); }
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f9fafb;color:#111}

/* Topbar */
.topbar{display:flex;align-items:center;justify-content:space-between;background:#fff;
  border-bottom:1px solid #e5e7eb;padding:10px 16px;position:sticky;top:0;z-index:10}
.brand{margin:0;font-size:17px;color:#0284c7}
.nav{display:flex;gap:18px}
.nav a{text-decoration:none;color:#333}
.nav a.active{color:#0284c7;font-weight:600}

/* Mobil-ikon-meny */
.mobile-launcher{display:none;max-width:1200px;margin:12px auto 0;padding:0 16px}
.ml-wrap{background:#f2f3f7;border:1px solid #e9e9ee;border-radius:18px;padding:14px;
  display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.ml-item{display:flex;flex-direction:column;align-items:center;gap:6px;padding:8px 4px;border-radius:12px}
.micon{width:48px;height:48px;border-radius:50%;background:#fff;display:grid;place-items:center;
  box-shadow:0 1px 3px rgba(0,0,0,.08);font-size:24px}
.ml-label{font-size:13px;color:#111827}
@media(max-width:700px){ .nav{display:none} .mobile-launcher{display:block} }

/* Sidlayout */
.page{max-width:1200px;margin:16px auto;padding:0 16px 24px}
.page h2{margin-top:0}

/* Kortlayout (Dagab) */
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(270px,1fr));gap:16px;margin-top:10px}
.card{border:1px solid var(--border);border-radius:12px;background:#fff;box-shadow:var(--shadow);
  overflow:hidden;cursor:pointer;transition:box-shadow .15s ease}
.card:hover{box-shadow:0 3px 10px rgba(0,0,0,.08)}
.card-header{display:flex;align-items:center;gap:10px;padding:12px}
.chev{transition:transform .18s ease;user-select:none;font-size:16px}
.card.expanded .chev{transform:rotate(90deg)}
.summary{white-space:pre-wrap;margin:0;flex:1;font-size:14px;line-height:1.3}
.divider{border:none;border-top:1px solid #eee;margin:0}
.details{display:none;padding:10px 14px 12px}
.card.expanded .details{display:block}
.details ul{margin:8px 0 0 0;padding-left:20px;line-height:1.4}
.details li{margin-bottom:6px}
.details li.store{font-weight:600;color:#111827}
.details li.qty{color:#4b5563}
.details li.qtyblock>div{line-height:1.3}
.details li.total{font-weight:600}
.details li.note{margin-top:6px;color:#991b1b}
.muted{color:#6b7280;font-size:13px}

/* Nyheter */
.news{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
.news .item{border:1px solid var(--border);border-radius:12px;background:#fff;box-shadow:var(--shadow);padding:14px}
.news .item h3{margin:0 0 6px}
.news .meta{font-size:12px;color:#6b7280;margin-bottom:8px}

/* Kontakter */
table.contacts{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--border);
  border-radius:12px;overflow:hidden;box-shadow:var(--shadow)}
table.contacts th,table.contacts td{padding:10px;border-bottom:1px solid #eee;text-align:left}
table.contacts th{background:#f9fafb;font-weight:600;font-size:14px}
</style>
</head>
<body>

<!-- TOPPMENY -->
<header class="topbar">
  <h1 class="brand">KOF ‚Äì Chauff√∂rportal</h1>
  <nav class="nav">
    <a href="#/home" id="link-home">Home</a>
    <a href="#/dagab" id="link-dagab">Dagab</a>
    <a href="#/nyheter" id="link-nyheter">Nyheter</a>
    <a href="#/kontakter" id="link-kontakter">Kontakter</a>
  </nav>
</header>

<!-- MOBILMENY (ikoner) -->
<div class="mobile-launcher">
  <div class="ml-wrap">
    <a class="ml-item" href="#/home" id="ml-home"><span class="micon">üè†</span><span class="ml-label">Home</span></a>
    <a class="ml-item" href="#/dagab" id="ml-dagab"><span class="micon">üöö</span><span class="ml-label">Dagab</span></a>
    <a class="ml-item" href="#/nyheter" id="ml-nyheter"><span class="micon">üì∞</span><span class="ml-label">Nyheter</span></a>
    <a class="ml-item" href="#/kontakter" id="ml-kontakter"><span class="micon">üë•</span><span class="ml-label">Kontakter</span></a>
  </div>
</div>

<!-- SIDOR -->
<main>
  <!-- HOME -->
  <section id="page-home" class="page" data-page>
    <h2>V√§lkommen!</h2>
    <p>H√§r visas de <strong>senaste nyheterna</strong>. Fler nyheter hittar du under menyn <em>Nyheter</em>.</p>
    <section style="margin-top:18px">
      <h3>üì∞ Senaste nytt</h3>
      <div id="latestNews" class="news"></div>
    </section>
  </section>

  <!-- DAGAB -->
  <section id="page-dagab" class="page" data-page hidden>
    <h2>Dagens turer</h2>
    <div id="grid" class="grid"></div>
    <p id="status" class="muted" style="text-align:right;margin-top:10px"></p>
  </section>

  <!-- NYHETER -->
  <section id="page-nyheter" class="page" data-page hidden>
    <h2>Nyheter</h2>
    <div id="newsList" class="news"></div>
  </section>

  <!-- KONTAKTER -->
  <section id="page-kontakter" class="page" data-page hidden>
    <h2>Kontakter</h2>
    <div style="overflow:auto">
      <table class="contacts" id="contactsTable">
        <thead><tr><th>Namn</th><th>Roll</th><th>Telefon</th><th>E-post</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<!-- App-script (med Firestore) -->
<script type="module">
/* ---------------- Router ---------------- */
function setActive(hash){
  document.querySelectorAll('.nav a').forEach(a=>a.classList.remove('active'));
  document.querySelectorAll('.mobile-launcher .ml-item').forEach(a=>a.classList.remove('active'));
  const d = document.querySelector(`.nav a[href="${hash}"]`); if(d) d.classList.add('active');
  const m = document.querySelector(`.mobile-launcher .ml-item[href="${hash}"]`); if(m) m.classList.add('active');
}
function showPage(id){
  document.querySelectorAll('[data-page]').forEach(s=>s.hidden=true);
  document.getElementById(id).hidden=false;
}
function handleRoute(){
  const h = location.hash || '#/home';
  setActive(h);
  if(h === '#/dagab'){ showPage('page-dagab'); ensureDagabReady(); }
  else if(h === '#/nyheter'){ showPage('page-nyheter'); renderNewsAll(); }
  else if(h === '#/kontakter'){ showPage('page-kontakter'); renderContacts(); }
  else { showPage('page-home'); renderLatestNews(); }
}
window.addEventListener('hashchange', handleRoute);

/* --------------- Dagab --------------- */
const DATA_URL = "https://therulest.github.io/kof-chaufforinfo/data.json";
let dagabInitialized = false;

function ensureDagabReady(){
  if(dagabInitialized) return;
  dagabInitialized = true;
  loadDagab();
}

async function loadDagab(){
  const grid = document.getElementById('grid');
  const status = document.getElementById('status');
  grid.innerHTML = '<p>Laddar‚Ä¶</p>'; status.textContent = '';
  try{
    const res = await fetch(DATA_URL + '?v=' + Date.now(), {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    buildCards(data);
    const t = new Date(data.updated_at || Date.now());
    status.textContent = 'Senast uppdaterad: ' + t.toLocaleString('sv-SE');
  }catch(err){
    grid.innerHTML = '<p style="color:#b00020">Kunde inte l√§sa data.</p>';
    status.textContent = String(err);
  }
}

function buildCards(data){
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  const cars = data.cars || [];
  cars.forEach((car,i)=>grid.append(buildCard(car,i,false)));
}

function buildCard(car, idx, expanded=false){
  const card = document.createElement('div');
  card.className = 'card' + (expanded ? ' expanded' : '');

  // S√§kra data
  const summaryText = String(car.summary || '');
  const lines = summaryText.split(/\r?\n/);
  const head = lines.slice(0,6);
  const details = Array.isArray(car.details) && car.details.length ? car.details.map(String) : lines.slice(6);

  // Header
  const header = document.createElement('div'); header.className='card-header';
  const chev = document.createElement('span'); chev.className='chev'; chev.textContent='‚ñ∂';
  const pre = document.createElement('pre'); pre.className='summary'; pre.textContent=head.join('\n');
  header.append(chev, pre); card.append(header);

  // Details
  if(details.length){
    card.append(Object.assign(document.createElement('hr'),{className:'divider'}));
    const d = document.createElement('div'); d.className='details';
    const ul = document.createElement('ul');

    for(let i=0;i<details.length;i++){
      const line = String(details[i]);
      const lower = line.toLowerCase().trim();

      // Frys/Kyl/Kol i block
      if(/^frys\s*:/.test(lower)){
        const group=[line];
        const n1=details[i+1]||'', n2=details[i+2]||'';
        if(/^\s*kyl\s*:/.test(String(n1).toLowerCase())){ group.push(n1); i++; }
        if(/^\s*kol\s*:/.test(String(n2).toLowerCase())){ group.push(n2); i++; }
        const li=document.createElement('li'); li.className='qtyblock';
        li.innerHTML=group.map(t=>`<div>${escapeHtml(t)}</div>`).join('');
        ul.append(li); continue;
      }

      const li=document.createElement('li'); li.textContent=line;
      const isQty=/\b(frys|kyl|kol)\b/.test(lower);
      const isTotal=lower.startsWith('totalt');
      const isNote=lower.startsWith('gl√∂m')||lower.startsWith('glom');
      if(isQty) li.classList.add('qty');
      if(isTotal) li.classList.add('total');
      if(isNote) li.classList.add('note');

      const next=details[i+1];
      if(next){
        const nextIsQty=/\b(frys|kyl|kol)\b/.test(String(next).toLowerCase());
        if(!isQty && !isTotal && !isNote && nextIsQty) li.classList.add('store');
      }
      ul.append(li);
    }
    d.append(ul); card.append(d);
  }

  // Expand/collapse
  card.addEventListener('click', e=>{
    if(e.target.closest('button,select,a')) return;
    if(!card.querySelector('.details')) return;
    card.classList.toggle('expanded');
  });

  return card;
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* --------------- Firestore: Nyheter & Kontakter --------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, getDocs, orderBy, limit, query } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDUPTHaLl4j_Wfp4kK62uBOQSotdl0QOjc",
  authDomain: "kofnord-1e371.firebaseapp.com",
  projectId: "kofnord-1e371",
  storageBucket: "kofnord-1e371.appspot.com",
  messagingSenderId: "559491880457",
  appId: "1:559491880457:web:b57bbf0bd1bb11ac3f0ad8"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

let latestLoaded = false;
let newsLoaded = false;
let contactsLoaded = false;

async function renderLatestNews(){
  if(latestLoaded) return;
  const box = document.getElementById('latestNews');
  if(!box) return;
  box.innerHTML = '<p class="muted">Laddar nyheter‚Ä¶</p>';
  try{
    const qy = query(collection(db,'news'), orderBy('date','desc'), limit(3));
    const snap = await getDocs(qy);
    if(snap.empty){ box.innerHTML = '<p class="muted">Inga nyheter √§nnu.</p>'; latestLoaded=true; return; }
    box.innerHTML = '';
    snap.forEach(d=>{
      const n = d.data();
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <h3>${escapeHtml(n.title || '')}</h3>
        <div class="meta">${n.date ? new Date(n.date).toLocaleDateString('sv-SE') : ''}</div>
        <p>${escapeHtml((n.body||'').split('\n')[0])}${(n.body||'').length>100?'‚Ä¶':''}</p>`;
      box.appendChild(div);
    });
    latestLoaded = true;
  }catch(e){
    console.error(e);
    box.innerHTML = '<p style="color:#b00020">Kunde inte l√§sa nyheter.</p>';
  }
}

async function renderNewsAll(){
  if(newsLoaded) return;
  const box = document.getElementById('newsList');
  if(!box) return;
  box.innerHTML = '<p class="muted">Laddar nyheter‚Ä¶</p>';
  try{
    const qy = query(collection(db,'news'), orderBy('date','desc'));
    const snap = await getDocs(qy);
    if(snap.empty){ box.innerHTML = '<p class="muted">Inga nyheter √§nnu.</p>'; newsLoaded=true; return; }
    box.innerHTML = '';
    snap.forEach(d=>{
      const n = d.data();
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <h3>${escapeHtml(n.title || '')}</h3>
        <div class="meta">${n.date ? new Date(n.date).toLocaleDateString('sv-SE') : ''}</div>
        <p>${escapeHtml(n.body || '').replace(/\n/g,'<br>')}</p>`;
      box.appendChild(div);
    });
    newsLoaded = true;
  }catch(e){
    console.error(e);
    box.innerHTML = '<p style="color:#b00020">Kunde inte l√§sa nyheter.</p>';
  }
}

async function renderContacts(){
  if(contactsLoaded) return;
  const tb = document.querySelector('#contactsTable tbody');
  if(!tb) return;
  tb.innerHTML = '<tr><td colspan="4" class="muted">Laddar kontakter‚Ä¶</td></tr>';
  try{
    const qy = query(collection(db,'contacts'), orderBy('sort','asc'), orderBy('name','asc'));
    const snap = await getDocs(qy);
    tb.innerHTML = '';
    if(snap.empty){
      tb.innerHTML = '<tr><td colspan="4" class="muted">Inga kontakter √§nnu.</td></tr>';
      contactsLoaded = true; return;
    }
    snap.forEach(d=>{
      const c = d.data();
      const tr = document.createElement('tr');
      const phone = (c.phone||'').replace(/\s+/g,'');
      tr.innerHTML = `
        <td>${escapeHtml(c.name||'')}</td>
        <td>${escapeHtml(c.role||'')}</td>
        <td>${c.phone ? `<a href="tel:${phone}">${escapeHtml(c.phone)}</a>` : ''}</td>
        <td>${c.email ? `<a href="mailto:${escapeHtml(c.email)}">${escapeHtml(c.email)}</a>` : ''}</td>`;
      tb.appendChild(tr);
    });
    contactsLoaded = true;
  }catch(e){
    console.error(e);
    tb.innerHTML = '<tr><td colspan="4" style="color:#b00020">Kunde inte l√§sa kontakter.</td></tr>';
  }
}

/* Start */
handleRoute();           // visa r√§tt sida vid laddning
</script>
</body>
</html>

