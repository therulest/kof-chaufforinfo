<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KOF ‚Äì Chauff√∂rportal</title>
<style>
  :root{--brand:#0ea5e9;--muted:#6b7280;--border:#e5e7eb;--bg:#fafafa}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#111827}
  a{color:inherit;text-decoration:none}

  /* Topbar */
  .topbar{position:sticky;top:0;z-index:30;background:#fff;border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:10px 16px;gap:12px}
  .brand{font-weight:700;color:var(--brand)}
  .nav{display:flex;gap:8px}
  .nav a{padding:8px 12px;border-radius:10px}
  .nav a.active,.nav a:hover{background:#eef6ff}

  /* Pages */
  .page{max-width:1200px;margin:16px auto;padding:0 16px 24px}
  header.pagehead{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:12px}
  .grid{display:grid;grid-gap:12px}
  @media(min-width:700px){.grid{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}}
  .card{border:1px solid var(--border);border-radius:12px;background:#fff;padding:12px}
  .muted{color:var(--muted)}

  /* PIN-l√•s */
  .lock-overlay{position:fixed;inset:0;background:rgba(250,250,250,.98);display:none;align-items:center;justify-content:center;z-index:9999}
  .lock-card{width:min(420px,92vw);background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.10);padding:20px}
  .lock-title{margin:0 0 8px 0;font-size:20px}
  .lock-sub{margin:0 0 16px 0;font-size:13px;color:var(--muted)}
  .lock-row{display:flex;gap:8px}
  .lock-input{flex:1;border:1px solid #d1d5db;border-radius:10px;padding:10px 12px;font-size:16px}
  .lock-btn{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-size:15px;cursor:pointer}
  .lock-err{margin-top:10px;color:#b00020;font-size:13px;min-height:1.2em}
  .btn{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:8px 12px;cursor:pointer}
  select.control{padding:8px 12px;border:1px solid #d1d5db;border-radius:8px}
</style>
</head>
<body>

<!-- PIN-l√•s overlay -->
<div class="lock-overlay" id="lock">
  <div class="lock-card">
    <h2 class="lock-title">L√•st</h2>
    <p class="lock-sub" id="lockMsg">Denna portal kr√§ver PIN-kod.</p>
    <div class="lock-row">
      <input id="pin" class="lock-input" type="password" placeholder="PIN-kod">
      <button id="pinBtn" class="lock-btn">√ñppna</button>
    </div>
    <div id="lockErr" class="lock-err"></div>
  </div>
</div>

<!-- Topbar -->
<div class="topbar">
  <div class="wrap">
    <div class="brand">KOF ‚Äì Chauff√∂rportal</div>
    <nav class="nav">
      <a href="#/home" id="link-home" class="active">Home</a>
      <a href="#/dagab" id="link-dagab">Dagab</a>
      <a href="#/nyheter" id="link-nyheter">Nyheter</a>
      <a href="#/kontakter" id="link-kontakter">Kontakter</a>
    </nav>
  </div>
</div>

<!-- Sidor -->
<main id="app" class="page">
  <!-- Home -->
  <section id="page-home" data-page>
    <div class="card">
      <h2 style="margin:0 0 6px">V√§lkommen!</h2>
      <p class="muted" style="margin:0">H√§r samlar vi information f√∂r v√•ra chauff√∂rer. Anv√§nd menyn ovan.</p>
    </div>
    <div id="latest-news" class="grid" style="margin-top:12px"></div>
  </section>

  <!-- Dagab (valfritt ‚Äì l√§ser ./data.json) -->
  <section id="page-dagab" data-page hidden>
    <header class="pagehead">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <h1 style="margin:0">Dagens turer</h1>
        <select id="bilSelect" class="control"><option value="all">Visa alla</option></select>
        <button id="refreshBtn" class="btn">üîÑ Uppdatera</button>
      </div>
      <div class="muted" id="stamp"></div>
    </header>
    <div class="grid" id="grid"></div>
  </section>

  <!-- Nyheter -->
  <section id="page-nyheter" data-page hidden>
    <header class="pagehead"><h1 style="margin:0">Nyheter</h1></header>
    <div id="newsList" class="grid"></div>
  </section>

  <!-- Kontakter -->
  <section id="page-kontakter" data-page hidden>
    <header class="pagehead"><h1 style="margin:0">Kontakter</h1></header>
    <div class="card" style="padding:0;overflow:auto">
      <table style="width:100%;border-collapse:collapse">
        <thead>
          <tr style="background:#f9fafb;border-bottom:1px solid var(--border)">
            <th style="text-align:left;padding:10px">Namn</th>
            <th style="text-align:left;padding:10px">Roll</th>
            <th style="text-align:left;padding:10px">Telefon</th>
            <th style="text-align:left;padding:10px">E-post</th>
          </tr>
        </thead>
        <tbody id="contactsBody"></tbody>
      </table>
    </div>
  </section>
</main>

<script type="module">
  // ===== Firebase (endast f√∂r l√§sning h√§r) =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, getDoc, orderBy, query, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDUPTHaLl4j_Wfp4kK62uBOQSotdl0QOjc",
    authDomain: "kofnord-1e371.firebaseapp.com",
    projectId: "kofnord-1e371",
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const $ = s => document.querySelector(s);

  /* ========= Router ========= */
  function setActive(hash){
    document.querySelectorAll('.nav a').forEach(a=>a.classList.remove('active'));
    const d=document.querySelector(`.nav a[href="${hash}"]`); if(d) d.classList.add('active');
  }
  function showPage(id){
    document.querySelectorAll('[data-page]').forEach(s=>s.hidden=true);
    document.getElementById(id).hidden=false;
  }
  function handleRoute(){
    const h=location.hash||'#/home';
    setActive(h);
    if(h==='#/dagab'){ showPage('page-dagab'); ensureDagabReady(); }
    else if(h==='#/nyheter'){ showPage('page-nyheter'); renderNews(); }
    else if(h==='#/kontakter'){ showPage('page-kontakter'); renderContacts(); }
    else { showPage('page-home'); renderLatestNews(); }
  }
  window.addEventListener('hashchange',handleRoute);

  /* ========= PIN-l√•s (settings/site) ========= */
  const LOCK_KEY='kof_portal_pin_hash';
  async function sha256Hex(str){
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  async function checkLock(){
    try{
      const snap = await getDoc(doc(db,'settings','site'));
      if(!snap.exists()){ unlockUI(); return; }
      const cfg = snap.data();
      const need = !!cfg.require_pin;
      const hash = (cfg.pin_hash||'').trim();
      $('#lockMsg').textContent = (cfg.lock_message || 'Denna portal kr√§ver PIN-kod.');

      if(!need || !hash){ unlockUI(); return; }
      if(localStorage.getItem(LOCK_KEY) === hash){ unlockUI(); return; }

      const lock = $('#lock'), pin=$('#pin'), err=$('#lockErr');
      lock.style.display='flex'; pin.focus();
      const tryOpen = async ()=>{
        err.textContent='';
        const input=(pin.value||'').trim();
        if(!input){ err.textContent='Ange PIN-kod.'; return; }
        if(await sha256Hex(input)===hash){ localStorage.setItem(LOCK_KEY,hash); unlockUI(); }
        else err.textContent='Fel PIN-kod.';
      };
      $('#pinBtn').onclick=tryOpen; pin.onkeydown=e=>{ if(e.key==='Enter') tryOpen(); };
    }catch(e){ console.error(e); unlockUI(); }
  }
  function unlockUI(){ $('#lock').style.display='none'; handleRoute(); }

  /* ========= Nyheter (read) ========= */
  async function renderNews(){
    const box=$('#newsList'); if(!box) return;
    box.innerHTML='<div class="card muted">Laddar nyheter‚Ä¶</div>';
    try{
      const qRef=query(collection(db,'news'),orderBy('date','desc'));
      const snap=await getDocs(qRef);
      if(snap.empty){ box.innerHTML='<div class="card muted">Inga nyheter √§nnu.</div>'; return; }
      box.innerHTML='';
      snap.forEach(d=>{
        const n=d.data();
        const el=document.createElement('div');
        el.className='card';
        el.innerHTML=`<h3 style="margin:0 0 6px">${n.title||''}</h3>
                      <div class="muted" style="font-size:12px;margin-bottom:6px">${n.date||''}</div>
                      <div>${(n.body||'').replace(/\n/g,'<br>')}</div>`;
        box.appendChild(el);
      });
    }catch(e){ console.error(e); box.innerHTML='<div class="card" style="color:#b00020">Kunde inte l√§sa nyheter.</div>'; }
  }
  async function renderLatestNews(){
    const box=$('#latest-news'); if(!box) return;
    box.innerHTML='';
    try{
      const qRef=query(collection(db,'news'),orderBy('date','desc'),limit(3));
      const snap=await getDocs(qRef);
      snap.forEach(d=>{
        const n=d.data();
        const el=document.createElement('div');
        el.className='card';
        el.innerHTML=`<strong>${n.title||''}</strong><div class="muted" style="font-size:12px">${n.date||''}</div>
                      <div class="muted" style="margin-top:4px">${(n.body||'').split('\n')[0]||''}</div>`;
        box.appendChild(el);
      });
    }catch(e){ /* no-op */ }
  }

  /* ========= Kontakter (read) ========= */
  async function renderContacts(){
    const tb=$('#contactsBody'); if(!tb) return;
    tb.innerHTML='<tr><td class="muted" colspan="4" style="padding:10px">Laddar‚Ä¶</td></tr>';
    try{
      const qRef=query(collection(db,'contacts')); // sorteras client-side
      const snap=await getDocs(qRef);
      const arr=[];
      snap.forEach(d=>arr.push({id:d.id,...d.data()}));
      arr.sort((a,b)=> (a.sort??999)-(b.sort??999) || (a.name||'').localeCompare(b.name||''));
      tb.innerHTML='';
      arr.forEach(c=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td style="padding:10px;border-bottom:1px solid var(--border)">${c.name||''}</td>
                      <td style="padding:10px;border-bottom:1px solid var(--border)">${c.role||''}</td>
                      <td style="padding:10px;border-bottom:1px solid var(--border)"><a href="tel:${(c.phone||'').replace(/\s+/g,'')}">${c.phone||''}</a></td>
                      <td style="padding:10px;border-bottom:1px solid var(--border)"><a href="mailto:${c.email||''}">${c.email||''}</a></td>`;
        tb.appendChild(tr);
      });
      if(!arr.length) tb.innerHTML='<tr><td class="muted" colspan="4" style="padding:10px">Inga kontakter.</td></tr>';
    }catch(e){ console.error(e); tb.innerHTML='<tr><td colspan="4" style="padding:10px;color:#b00020">Kunde inte l√§sa.</td></tr>'; }
  }

  /* ========= Dagab (valfritt) ========= */
  let cars=[];
  async function loadData(){
    const grid=$('#grid'); grid.innerHTML='<div class="card muted">Laddar‚Ä¶</div>';
    try{
      const res=await fetch('./data.json?v='+Date.now(),{cache:'no-store'});
      const data=await res.json();
      $('#stamp').textContent='Senast uppdaterad: '+(new Date(data.updated_at)).toLocaleString();
      cars = Array.isArray(data.cars)? data.cars : [];
      const sel=$('#bilSelect'); sel.innerHTML='<option value="all">Visa alla</option>';
      cars.forEach((c,i)=>{ const o=document.createElement('option'); o.value=i;o.textContent=c.label||`Bil ${i+1}`; sel.appendChild(o); });
      renderAll();
    }catch(e){ grid.innerHTML='<div class="card" style="color:#b00020">Kunde inte l√§sa data.json</div>'; }
  }
  function buildCard(car,expanded=false){
    const div=document.createElement('div'); div.className='card';
    const header=document.createElement('div'); header.innerHTML=`<pre style="white-space:pre-wrap;margin:0">${car.summary||''}</pre>`;
    div.appendChild(header);
    if(Array.isArray(car.details)&&car.details.length){
      const hr=document.createElement('hr'); div.appendChild(hr);
      const ul=document.createElement('ul'); ul.style.margin='0'; ul.style.padding='0 0 0 18px';
      car.details.forEach(t=>{ const li=document.createElement('li'); li.textContent=t; ul.appendChild(li); });
      div.appendChild(ul);
    }
    return div;
  }
  function renderAll(){ const g=$('#grid'); g.innerHTML=''; cars.forEach(c=>g.appendChild(buildCard(c,false))); }
  function renderOne(i){ const g=$('#grid'); g.innerHTML=''; if(cars[i]) g.appendChild(buildCard(cars[i],true)); }
  function ensureDagabReady(){
    const sel=$('#bilSelect'), btn=$('#refreshBtn');
    if(!btn._b){ btn.addEventListener('click',loadData); btn._b=true; }
    if(!sel._b){ sel.addEventListener('change',e=> e.target.value==='all'?renderAll():renderOne(parseInt(e.target.value,10))); sel._b=true; }
    loadData();
  }

  // Start
  checkLock();
</script>
</body>
</html>

