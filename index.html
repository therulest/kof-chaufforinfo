<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>KOF ‚Äì Chauff√∂rsportal</title>
<style>
:root{
  --border:#e5e7eb;--shadow:0 1px 3px rgba(0,0,0,.05);--wrap:1000px;
  --ink:#0f172a;--muted:#475569;--blue:#0284c7;--blue-ink:#0369a1;--blue-100:#e0f2fe;--chip-bg:#f8fafc
}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f9fafb;color:var(--ink)}

/* Topbar */
.topbar{background:#fff;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10;transition:box-shadow .18s,border-color .18s}
.topbar.scrolled{box-shadow:0 6px 18px rgba(2,8,23,.06);border-color:#eef2f7}
.topbar .wrap{max-width:var(--wrap);margin:0 auto;padding:10px 16px;display:flex;align-items:center;justify-content:space-between;gap:14px}

/* Brand / logo */
.brand{display:flex;align-items:center;text-decoration:none}
.brand-logo{height:38px;width:auto;display:block;transition:opacity .15s}
.brand:hover .brand-logo{opacity:.9}
@media(max-width:700px){.brand-logo{height:32px}}

/* Toppmeny */
.nav{display:flex;gap:6px;background:var(--chip-bg);padding:6px;border:1px solid var(--border);border-radius:9999px;box-shadow:var(--shadow);align-items:center}
.nav a{--pad-x:14px;text-decoration:none;color:#334155;padding:8px var(--pad-x);border-radius:9999px;font-size:14px;font-weight:600;line-height:1;transition:background .15s,box-shadow .15s,color .15s,transform .04s}
.nav a:hover{background:#eef2f7}
.nav a:active{transform:translateY(1px)}
.nav a.active{background:var(--blue-100);color:var(--blue-ink);box-shadow:inset 0 0 0 1px #bae6fd}
.nav a:focus-visible{outline:2px solid #93c5fd;outline-offset:2px}

/* Dropdown f√∂r Distrikt */
.dropdown{position:relative}
.dropdown > a{display:inline-flex;align-items:center;gap:6px}
.dropdown .chev{font-size:12px;transition:transform .18s}
.dropdown.open > a .chev{transform:rotate(180deg)}
.dropdown-menu{
  position:absolute;top:100%;left:50%;transform:translateX(-50%);
  background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 10px 24px rgba(2,8,23,.12);
  padding:8px;display:none;min-width:260px;
}
.dropdown.open .dropdown-menu{display:block}
.dropdown-menu a{display:flex;align-items:center;gap:10px;border-radius:10px;padding:10px 12px;color:#0f172a;text-decoration:none}
.dropdown-menu a:hover{background:#f1f5f9}
.dm-badge{
  width:28px;height:28px;border-radius:8px;display:grid;place-items:center;
  font-weight:800;color:#0b1324;background:linear-gradient(135deg,#e0f2fe,#c7e2ff);
  border:1px solid #cde6ff; box-shadow:inset 0 1px 0 rgba(255,255,255,.8);
  font-size:12px
}

/* Mobil-ikon-grid */
.mobile-launcher{display:none}
@media(max-width:700px){.nav{display:none}.mobile-launcher{display:block}}
.mobile-launcher .wrap{max-width:var(--wrap);margin:12px auto 0;padding:0 16px}
.ml-grid{
  background:#f2f3f7;border:1px solid #e9e9ee;border-radius:18px;padding:14px;
  display:grid;grid-template-columns:repeat(4,1fr);gap:8px
}
/* D√∂lj alla ikoner fr√•n och med den 5:e n√§r griden √§r kollapsad (mobill√§ge) */
@media(max-width:700px){
  .ml-grid.collapsed .ml-item:nth-child(n+5){display:none}
}
/* Toggle-knapp under ikon-griden (mobill√§ge) */
.ml-toggle{display:none}
@media(max-width:700px){
  .ml-toggle{display:flex;justify-content:center;margin-top:8px}
  .ml-toggle button{
    appearance:none;background:#fff;border:1px solid var(--border);
    border-radius:9999px;padding:8px 12px;font-weight:700;cursor:pointer;box-shadow:var(--shadow)
  }
  .ml-toggle button:active{transform:translateY(1px)}
}
.ml-item{display:flex;flex-direction:column;align-items:center;gap:6px;padding:10px 6px;border-radius:12px;text-decoration:none;color:#111;transition:transform .06s,box-shadow .15s,background .15s}
.ml-item:hover{background:#fff;box-shadow:0 3px 10px rgba(0,0,0,.08)}
.ml-item:active{transform:translateY(1px)}
.micon{width:48px;height:48px;border-radius:12px;background:#fff;display:grid;place-items:center;box-shadow:0 1px 3px rgba(0,0,0,.08);font-size:24px}
.micon.badge{background:linear-gradient(135deg,#e0f2fe,#c7e2ff);border:1px solid #cde6ff;font-weight:800;font-size:14px;color:#0b1324}
.ml-label{font-size:13px;color:#111827;font-weight:600}

/* Sidlayout */
.page{max-width:var(--wrap);margin:16px auto;padding:0 16px 24px}
.page h2{margin:0}

/* Flikar p√• regionsidor */
.tabs{display:flex;gap:16px;border-bottom:1px solid #e8eef6;margin:0 0 14px}
.tabs a{padding:10px 2px;text-decoration:none;color:#334155;font-weight:700;position:relative}
.tabs a.active{color:#0369a1}
.tabs a.active::after{content:"";position:absolute;left:0;right:0;bottom:-1px;height:3px;border-radius:3px;background:#7dd3fc}

/* Dagab cards */
.tools{display:flex;align-items:center;gap:12px;justify-content:space-between;margin:8px 0 12px}
.tools-left{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.tools-right{margin-left:auto;color:var(--muted);font-size:12px}
.btn{appearance:none;border:1px solid #0273ad;background:var(--blue);color:#fff;font-weight:700;border-radius:10px;padding:8px 12px;cursor:pointer;box-shadow:var(--shadow);transition:filter .15s,transform .04s}
.btn:hover{filter:brightness(1.05)}
.btn:active{transform:translateY(1px)}
.btn:disabled{opacity:.6;cursor:progress}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(270px,1fr));gap:16px;margin-top:10px}
.card{border:1px solid var(--border);border-radius:12px;background:#fff;box-shadow:var(--shadow);overflow:hidden;cursor:pointer;transition:box-shadow .15s}
.card:hover{box-shadow:0 3px 10px rgba(0,0,0,.08)}
.card-header{display:flex;align-items:center;gap:10px;padding:12px}
.chev{transition:transform .18s;user-select:none;font-size:16px}
.card.expanded .chev{transform:rotate(90deg)}
.summary{white-space:pre-wrap;margin:0;flex:1;font-size:14px;line-height:1.3}
.divider{border:none;border-top:1px solid #eee;margin:0}
.details{display:none;padding:10px 14px 12px}
.card.expanded .details{display:block}
.details ul{margin:8px 0 0 0;padding-left:20px;line-height:1.4}
.details li{margin-bottom:6px}
.details li.qty{color:#4b5563;margin-bottom:8px}
.details li.total{font-weight:700;margin-top:4px;margin-bottom:8px}
.details li.note{margin-top:6px;color:#991b1b}
.muted{color:#6b7280;font-size:13px}

/* Nyheter (home + nyheter-sida) */
.news{display:grid;grid-template-columns:1fr;gap:12px;width:100%;margin:0}
.news .item{border:1px solid var(--border);border-radius:12px;background:#fff;box-shadow:var(--shadow);padding:16px;cursor:pointer;transition:box-shadow .15s}
.news .item:hover{box-shadow:0 3px 10px rgba(0,0,0,.08)}
.news .item h3{margin:0 0 6px}
.news .meta{font-size:12px;color:#6b7280;margin-bottom:8px}
.news .more{color:var(--blue);font-weight:600;margin-top:6px;user-select:none}
.news .item.collapsed .more::after{content:" ‚Äì klicka f√∂r att l√§sa mer"}
.news .item.expanded .more::after{content:" ‚Äì klicka f√∂r att visa mindre"}
@keyframes flash{0%{box-shadow:0 0 0 0 rgba(2,132,199,.45)}40%{box-shadow:0 0 0 6px rgba(2,132,199,.15)}100%{box-shadow:0 1px 3px rgba(0,0,0,.05)}}
.highlight{animation:flash 1.3s ease-out 1}

/* Kontakter */
.contacts-toolbar{display:flex;align-items:center;gap:10px;margin:8px 0 12px}
.select{appearance:none;background:#fff;border:1px solid var(--border);border-radius:10px;padding:8px 12px;font-size:14px;box-shadow:var(--shadow)}
.contacts-acc{display:grid;gap:10px}
.contact-group{margin-top:18px}
.contact-group h3{margin:0 0 8px;font-size:16px;font-weight:800;color:#0f172a;display:flex;align-items:center;gap:8px}
.contact-count{font-size:12px;color:#475569;background:#eef2f7;border:1px solid #e5e7eb;border-radius:9999px;padding:2px 8px}
.contact-card{border:1px solid var(--border);border-radius:12px;background:#fff;box-shadow:var(--shadow);overflow:hidden}
.contact-head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;cursor:pointer}
.contact-head .name{font-weight:600}
.contact-head .chev{transition:transform .18s;font-size:16px}
.contact-card.open .contact-head .chev{transform:rotate(90deg)}
.contact-body{display:none;padding:0 14px 12px 14px}
.contact-card.open .contact-body{display:block}
.contact-body .row{margin:8px 0;color:#374151}
.contact-body a{color:#0ea5e9;text-decoration:none}

@media (prefers-reduced-motion: reduce){
  .chev,.nav a,.ml-item,.topbar,.dropdown .chev{transition:none}
}
</style>
</head>
<body>

<header class="topbar" id="topbar">
  <div class="wrap">
    <a href="#/home" class="brand">
      <img src="https://kylofrysexpressen.se/wp-content/themes/kof/images/kyl-o-frys-logo.png" alt="Kyl & Frysexpressen Nord AB" class="brand-logo">
    </a>

    <nav class="nav" aria-label="Huvudmeny">
      <a href="#/home" id="link-home">Home</a>
      <a href="#/dagab" id="link-dagab">Dagab</a>

      <div class="dropdown" id="dd-distrikt">
        <a href="#/distrikt" id="link-distrikt" aria-haspopup="true" aria-expanded="false">
          Distrikt <span class="chev">‚ñæ</span>
        </a>
        <div class="dropdown-menu" role="menu" aria-label="Distrikt">
          <a href="#/nyheter" role="menuitem"><span class="dm-badge">üì∞</span> Nyheter</a>
          <a href="#/fjarr" role="menuitem"><span class="dm-badge">FJ</span> Fj√§rr</a>
          <a href="#/sundsvall" role="menuitem"><span class="dm-badge">SU</span> Sundsvall</a>
          <a href="#/ostersund" role="menuitem"><span class="dm-badge">√ñS</span> √ñstersund</a>
          <a href="#/umea" role="menuitem"><span class="dm-badge">UM</span> Ume√•</a>
          <a href="#/lulea" role="menuitem"><span class="dm-badge">LU</span> Lule√•</a>
          <a href="#/stab" role="menuitem"><span class="dm-badge">ST</span> Stab</a>
        </div>
      </div>

      <a href="#/kontakter" id="link-kontakter">Kontakter</a>
    </nav>
  </div>
</header>

<!-- Mobil snabbmeny -->
<div class="mobile-launcher" aria-label="Snabbmeny">
  <div class="wrap">
    <div class="ml-grid collapsed" id="mlGrid">
      <a class="ml-item" href="#/home"><span class="micon">üè†</span><span class="ml-label">Home</span></a>
      <a class="ml-item" href="#/nyheter"><span class="micon">üì∞</span><span class="ml-label">Nyheter</span></a>
      <a class="ml-item" href="#/dagab"><span class="micon">üöö</span><span class="ml-label">Dagab</span></a>
      <a class="ml-item" href="#/kontakter"><span class="micon">üë•</span><span class="ml-label">Kontakter</span></a>
      <a class="ml-item" href="#/fjarr"><span class="micon badge">FJ</span><span class="ml-label">Fj√§rr</span></a>
      <a class="ml-item" href="#/sundsvall"><span class="micon badge">SU</span><span class="ml-label">Sundsvall</span></a>
      <a class="ml-item" href="#/ostersund"><span class="micon badge">√ñS</span><span class="ml-label">√ñstersund</span></a>
      <a class="ml-item" href="#/umea"><span class="micon badge">UM</span><span class="ml-label">Ume√•</span></a>
      <a class="ml-item" href="#/lulea"><span class="micon badge">LU</span><span class="ml-label">Lule√•</span></a>
      <a class="ml-item" href="#/stab"><span class="micon badge">ST</span><span class="ml-label">Stab</span></a>
    </div>
    <div class="ml-toggle">
      <button id="mlMoreBtn" aria-expanded="false" aria-controls="mlGrid" type="button">Visa fler ‚ñæ</button>
    </div>
  </div>
</div>

<main>
  <!-- HOME -->
<section id="page-home" class="page" data-page>
  <div class="intro" hidden>
    <h2>V√§lkommen till KOF-Nords Chauff√∂rsportal</h2>
    <p>H√§r ser du de senaste uppdateringarna. Klicka f√∂r att l√§sa hela nyheten under <em>Nyheter</em>.</p>
  </div>

  <h3 style="margin-top:0">üì∞ Senaste nytt</h3>
  <div id="latestNewsHome" class="news"></div>
</section>


  <!-- DAGAB -->
  <section id="page-dagab" class="page" data-page hidden>
    <div class="tools">
      <div class="tools-left">
        <h2>Dagens turer</h2>
        <button id="btnRefresh" class="btn">Uppdatera</button>
      </div>
      <div class="tools-right"><span id="status"></span></div>
    </div>
    <div id="grid" class="grid"></div>
  </section>

  <!-- NYHETER -->
  <section id="page-nyheter" class="page" data-page hidden>
    <h2>Nyheter</h2>
    <div id="newsList" class="news"></div>
  </section>

  <!-- KONTAKTER -->
  <section id="page-kontakter" class="page" data-page hidden>
    <div class="contacts-toolbar">
      <h2 style="margin-right:auto">Kontakter</h2>
      <label for="roleFilter" class="muted" style="font-size:13px">Filter:</label>
      <select id="roleFilter" class="select" aria-label="Filtrera p√• roll"></select>
    </div>
    <div id="contactsList"></div>
  </section>

  <!-- REGIONSIDOR -->
  <section id="page-fjarr" class="page" data-page hidden>
    <nav class="tabs">
      <a href="#/fjarr" class="active">Fj√§rr</a><a href="#/sundsvall">Sundsvall</a><a href="#/ostersund">√ñstersund</a>
      <a href="#/umea">Ume√•</a><a href="#/lulea">Lule√•</a><a href="#/stab">Stab</a>
    </nav>
    <h2>Fj√§rr</h2><p class="muted">L√§gg fj√§rrspecifikt inneh√•ll h√§r.</p>
  </section>

  <section id="page-sundsvall" class="page" data-page hidden>
    <nav class="tabs">
      <a href="#/fjarr">Fj√§rr</a><a href="#/sundsvall" class="active">Sundsvall</a><a href="#/ostersund">√ñstersund</a>
      <a href="#/umea">Ume√•</a><a href="#/lulea">Lule√•</a><a href="#/stab">Stab</a>
    </nav>
    <h2>Sundsvall</h2><p class="muted">Inneh√•ll f√∂r Sundsvall.</p>
  </section>

  <section id="page-ostersund" class="page" data-page hidden>
    <nav class="tabs">
      <a href="#/fjarr">Fj√§rr</a><a href="#/sundsvall">Sundsvall</a><a href="#/ostersund" class="active">√ñstersund</a>
      <a href="#/umea">Ume√•</a><a href="#/lulea">Lule√•</a><a href="#/stab">Stab</a>
    </nav>
    <h2>√ñstersund</h2><p class="muted">Inneh√•ll f√∂r √ñstersund.</p>
  </section>

  <section id="page-umea" class="page" data-page hidden>
    <nav class="tabs">
      <a href="#/fjarr">Fj√§rr</a><a href="#/sundsvall">Sundsvall</a><a href="#/ostersund">√ñstersund</a>
      <a href="#/umea" class="active">Ume√•</a><a href="#/lulea">Lule√•</a><a href="#/stab">Stab</a>
    </nav>
    <h2>Ume√•</h2><p class="muted">Inneh√•ll f√∂r Ume√•.</p>
  </section>

  <section id="page-lulea" class="page" data-page hidden>
    <nav class="tabs">
      <a href="#/fjarr">Fj√§rr</a><a href="#/sundsvall">Sundsvall</a><a href="#/ostersund">√ñstersund</a>
      <a href="#/umea">Ume√•</a><a href="#/lulea" class="active">Lule√•</a><a href="#/stab">Stab</a>
    </nav>
    <h2>Lule√•</h2><p class="muted">Inneh√•ll f√∂r Lule√•.</p>
  </section>

  <section id="page-stab" class="page" data-page hidden>
    <nav class="tabs">
      <a href="#/fjarr">Fj√§rr</a><a href="#/sundsvall">Sundsvall</a><a href="#/ostersund">√ñstersund</a>
      <a href="#/umea">Ume√•</a><a href="#/lulea">Lule√•</a><a href="#/stab" class="active">Stab</a>
    </nav>
    <h2>Stab</h2><p class="muted">Inneh√•ll f√∂r Stab.</p>
  </section>
</main>

<script type="module">
/* ===== ROUTING ===== */
function setActive(hash){
  document.querySelectorAll('.nav a').forEach(a=>{
    a.classList.remove('active'); a.removeAttribute('aria-current')
  });
  const clean=hash.split('/').slice(0,2).join('/');
  const direct=document.querySelector(`.nav a[href="${clean}"]`);
  if(direct){ direct.classList.add('active'); direct.setAttribute('aria-current','page'); }
  const route=(hash||'#/home').split('/')[1]||'home';
  const isRegion=REGION_ROUTES.includes(route) || route==='nyheter';
  if(isRegion){
    const dl=document.getElementById('link-distrikt');
    if(dl){ dl.classList.add('active'); dl.setAttribute('aria-current','page'); }
  }
}
function showPage(id){
  document.querySelectorAll('[data-page]').forEach(s=>s.hidden=true);
  document.getElementById(id).hidden=false
}
const REGION_ROUTES=['fjarr','sundsvall','ostersund','umea','lulea','stab'];
function handleRoute(){
  const h=location.hash||'#/home';
  const parts=h.split('/');
  const route=parts[1]||'home';
  const param=parts[2]||null;
  setActive(h);
  if(route==='dagab'){ showPage('page-dagab'); ensureDagabReady(); }
  else if(route==='nyheter'){ showPage('page-nyheter'); renderNewsAll(param); }
  else if(route==='kontakter'){ showPage('page-kontakter'); renderContacts(); }
  else if(REGION_ROUTES.includes(route)){ showPage('page-'+route); }
  else { showPage('page-home'); renderLatestNewsHome(); }
}
window.addEventListener('hashchange',handleRoute);

/* TOPBAR SKUGGA */
const topbar=document.getElementById('topbar');
function onScroll(){ topbar.classList.toggle('scrolled', window.scrollY>2); }
onScroll(); window.addEventListener('scroll',onScroll,{passive:true});

/* Dropdown-beteende f√∂r Distrikt */
const dd=document.getElementById('dd-distrikt');
const ddLink=document.getElementById('link-distrikt');
function closeDropdown(){ dd?.classList.remove('open'); ddLink?.setAttribute('aria-expanded','false'); }
ddLink?.addEventListener('click',(e)=>{ e.preventDefault(); dd.classList.toggle('open'); ddLink.setAttribute('aria-expanded', dd.classList.contains('open')?'true':'false'); });
document.addEventListener('click',(e)=>{ if(dd && !dd.contains(e.target)) closeDropdown(); });
dd?.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeDropdown(); });

/* ===== DAGAB ===== */
const DATA_URL="https://therulest.github.io/kof-chaufforinfo/data.json";
let dagabInitialized=false;
function ensureDagabReady(){ if(!dagabInitialized){ dagabInitialized=true; attachRefresh(); loadDagab(); } }
function attachRefresh(){ const b=document.getElementById('btnRefresh'); if(b) b.addEventListener('click',()=>loadDagab(true)); }
async function loadDagab(manual=false){
  const grid=document.getElementById('grid'), b=document.getElementById('btnRefresh'), s=document.getElementById('status');
  if(manual&&b){ b.disabled=true; b.textContent='Uppdaterar‚Ä¶'; }
  grid.innerHTML=manual?grid.innerHTML:'<p>Laddar‚Ä¶</p>';
  try{
    const res=await fetch(DATA_URL+'?v='+Date.now(),{cache:'no-store'});
    const data=await res.json();
    buildCards(data);
    const t=new Date(data.updated_at||Date.now());
    if(s) s.textContent='Senast uppdaterad: '+t.toLocaleString('sv-SE');
  }catch(e){
    grid.innerHTML='<p style="color:#b00020">Fel vid h√§mtning.</p>';
  }finally{
    if(manual&&b){ b.disabled=false; b.textContent='Uppdatera'; }
  }
}
function buildCards(data){
  const grid=document.getElementById('grid'); grid.innerHTML='';
  (data.cars||[]).forEach((car,i)=>grid.append(buildCard(car,i,false)));
}
function buildCard(car,idx,expanded){
  const card=document.createElement('div'); card.className='card'+(expanded?' expanded':'');
  const lines=String(car.summary||'').split(/\r?\n/);
  const head=lines.slice(0,6);
  const details=Array.isArray(car.details)&&car.details.length?car.details.map(String):lines.slice(6);
  const header=document.createElement('div'); header.className='card-header';
  const chev=document.createElement('span'); chev.className='chev'; chev.textContent='‚ñ∂';
  const pre=document.createElement('pre'); pre.className='summary'; pre.textContent=head.join('\n');
  header.append(chev,pre); card.append(header);
  if(details.length){
    card.append(Object.assign(document.createElement('hr'),{className:'divider'}));
    const d=document.createElement('div'); d.className='details'; const ul=document.createElement('ul');
    for(let i=0;i<details.length;i++){
      const line=String(details[i]); const lower=line.toLowerCase().trim(); const li=document.createElement('li'); li.textContent=line;
      if(lower.startsWith('gl√∂m')) li.classList.add('note');
      if(/^(frys|kyl|kol|totalt)\s*:/i.test(line)){
        if(/^totalt\s*:/i.test(line)) li.classList.add('total'); else li.classList.add('qty');
      }
      if(/(\d+)\s*(FRYS|KYL|KOL)/i.test(line)) li.classList.add('qty');
      ul.append(li);
    }
    d.append(ul); card.append(d);
  }
  card.addEventListener('click',()=>card.classList.toggle('expanded'));
  return card;
}
function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}

/* ===== FIREBASE ===== */
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {getFirestore,collection,getDocs,orderBy,limit,query} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
const firebaseConfig={apiKey:"AIzaSyDUPTHaLl4j_Wfp4kK62uBOQSotdl0QOjc",authDomain:"kofnord-1e371.firebaseapp.com",projectId:"kofnord-1e371",storageBucket:"kofnord-1e371.appspot.com",messagingSenderId:"559491880457",appId:"1:559491880457:web:b57bbf0bd1bb11ac3f0ad8"};
const app=initializeApp(firebaseConfig); const db=getFirestore(app);

/* HOME ‚Äì expanderbara nyheter */
function truncateText(txt,n=200){const s=String(txt||"");return s.length<=n?s:s.slice(0,n).trimEnd()+"‚Ä¶"}
let latestRendered=false;
async function renderLatestNewsHome(){
  if(latestRendered) return;
  const box=document.getElementById('latestNewsHome');
  box.innerHTML='<p class="muted">Laddar nyheter‚Ä¶</p>';
  try{
    const qy=query(collection(db,'news'),orderBy('date','desc'),limit(3));
    const snap=await getDocs(qy);
    box.innerHTML='';
    snap.forEach(doc=>{
      const n=doc.data();
      const full=String(n.body||'');
      const short=truncateText(full,200);
      const dstr=n.date?new Date(n.date).toLocaleDateString('sv-SE'):'';
      const item=document.createElement('div');
      item.className='item collapsed';
      item.innerHTML=`<h3>${escapeHtml(n.title||'')}</h3>
        <div class="meta">${dstr}</div>
        <p class="body">${escapeHtml(short).replace(/\n/g,'<br>')}</p>
        <div class="more">L√§s mer</div>`;
      item.dataset.short=short; item.dataset.full=full;
      item.addEventListener('click',()=>{
        const body=item.querySelector('.body');
        const expanded=item.classList.toggle('expanded');
        item.classList.toggle('collapsed',!expanded);
        body.innerHTML = expanded
          ? escapeHtml(item.dataset.full).replace(/\n/g,'<br>')
          : escapeHtml(item.dataset.short).replace(/\n/g,'<br>');
      });
      box.append(item);
    });
    latestRendered=true;
  }catch(e){
    console.error(e);
    box.innerHTML='<p style="color:#b00020">Kunde inte l√§sa nyheter.</p>';
  }
}

/* NYHETER-sidan */
let newsLoaded=false;
async function renderNewsAll(targetId=null){
  const box=document.getElementById('newsList');
  if(!newsLoaded){ box.innerHTML='<p class="muted">Laddar nyheter‚Ä¶</p>'; }
  try{
    if(!newsLoaded){
      const qy=query(collection(db,'news'),orderBy('date','desc'));
      const snap=await getDocs(qy);
      box.innerHTML='';
      snap.forEach(docSnap=>{
        const n=docSnap.data();
        const full=(n.body||'');
        const shortText=truncateText(full,200);
        const div=document.createElement('div'); 
        div.className='item collapsed'; 
        div.id='news-'+docSnap.id;
        div.dataset.full=full; 
        div.dataset.short=shortText;
        div.innerHTML=`<h3>${escapeHtml(n.title||'')}</h3>
          <div class="meta">${n.date?new Date(n.date).toLocaleDateString('sv-SE'):''}</div>
          <p class="body">${escapeHtml(shortText).replace(/\n/g,'<br>')}</p>
          <div class="more">L√§s mer</div>`;
        div.addEventListener('click',()=>{
          const body=div.querySelector('.body');
          const expanded=div.classList.toggle('expanded');
          div.classList.toggle('collapsed',!expanded);
          body.innerHTML=expanded
            ? escapeHtml(div.dataset.full).replace(/\n/g,'<br>')
            : escapeHtml(div.dataset.short).replace(/\n/g,'<br>');
        });
        box.append(div);
      });
      newsLoaded=true;
    }
    if(targetId){
      const el=document.getElementById('news-'+targetId);
      if(el){
        el.classList.add('highlight');
        setTimeout(()=>el.classList.remove('highlight'),1500);
        el.scrollIntoView({behavior:'smooth',block:'start'});
      }
    }
  }catch(e){
    console.error(e);
    box.innerHTML='<p style="color:#b00020">Kunde inte l√§sa nyheter.</p>';
  }
}

/* KONTAKTER */
let contactsCache=null; const LS_FILTER_KEY="contacts_role_filter_v1";
function roleFrom(c){return (c.role||'√ñvriga').trim()||'√ñvriga'}
async function fetchContacts(){
  const snap=await getDocs(collection(db,'contacts')); const groups=new Map();
  snap.forEach(d=>{const c=d.data(); const r=roleFrom(c); if(!groups.has(r)) groups.set(r,[]); groups.get(r).push({...c,id:d.id})});
  const collator=new Intl.Collator('sv-SE',{sensitivity:'base',numeric:true});
  for(const arr of groups.values()){arr.sort((a,b)=>collator.compare(a.name||'',b.name||''))}
  const roles=Array.from(groups.keys()).sort(collator.compare); contactsCache={roles,groups,count:snap.size};
}
function createContactCard(c){
  const card=document.createElement('div'); card.className='contact-card';
  card.innerHTML=`<div class="contact-head" role="button" tabindex="0">
    <span class="name">${escapeHtml(c.name||'')}</span><span class="chev">‚ñ∂</span></div>
  <div class="contact-body">
    ${c.role?`<div class="row"><strong>Roll:</strong> ${escapeHtml(c.role)}</div>`:''}
    ${c.phone?`<div class="row"><strong>Telefon:</strong> <a href="tel:${String(c.phone).replace(/\s+/g,'')}">${escapeHtml(c.phone)}</a></div>`:''}
    ${c.email?`<div class="row"><strong>E-post:</strong> <a href="mailto:${escapeHtml(c.email)}">${escapeHtml(c.email)}</a></div>`:''}
  </div>`;
  const head=card.querySelector('.contact-head');
  const toggle=()=>card.classList.toggle('open');
  head.addEventListener('click',toggle);
  head.addEventListener('keydown',e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();toggle();}});
  return card;
}
function renderContactsUI(filterRole){
  const container=document.getElementById('contactsList'); const {roles,groups}=contactsCache; container.innerHTML='';
  const renderRoles=filterRole&&filterRole!=='ALL'?[filterRole]:roles;
  renderRoles.forEach(role=>{
    const people=groups.get(role)||[]; const sec=document.createElement('section'); sec.className='contact-group';
    sec.innerHTML=`<h3>${escapeHtml(role)} <span class="contact-count">${people.length}</span></h3>`;
    const acc=document.createElement('div'); acc.className='contacts-acc'; people.forEach(p=>acc.append(createContactCard(p)));
    sec.append(acc); container.append(sec);
  });
}
function populateFilterSelect(){
  const sel=document.getElementById('roleFilter'); const saved=localStorage.getItem(LS_FILTER_KEY)||'ALL';
  sel.innerHTML=''; sel.add(new Option('Alla roller','ALL')); contactsCache.roles.forEach(r=>sel.add(new Option(r,r)));
  sel.value=saved; sel.onchange=()=>{localStorage.setItem(LS_FILTER_KEY,sel.value);renderContactsUI(sel.value)}
}
async function renderContacts(){
  const container=document.getElementById('contactsList'); container.innerHTML='<div class="muted">Laddar kontakter‚Ä¶</div>';
  try{
    if(!contactsCache) await fetchContacts();
    populateFilterSelect();
    const current=document.getElementById('roleFilter').value||'ALL';
    renderContactsUI(current);
  }catch(e){
    console.error('Kontaktfel:',e);
    container.innerHTML='<div style="color:#b00020">Kunde inte l√§sa kontakter.</div>';
  }
}

/* Mobila ikoner: Visa fler/f√§rre */
const mlGrid=document.getElementById('mlGrid');
const mlBtn=document.getElementById('mlMoreBtn');
if(mlGrid && mlBtn){
  mlBtn.addEventListener('click',()=>{
    const collapsed=mlGrid.classList.toggle('collapsed'); // true=kollapsad, false=expanderad
    const expanded=!collapsed;
    mlBtn.setAttribute('aria-expanded', String(expanded));
    mlBtn.textContent = expanded ? 'Visa f√§rre ‚ñ¥' : 'Visa fler ‚ñæ';
  });
}

/* Start */
handleRoute();
</script>
</body>
</html>















