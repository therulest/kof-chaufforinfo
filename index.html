<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Chauff√∂rinfo</title>
<style>
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    margin: 16px;
    background: #fafafa;
  }
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    flex-wrap: wrap;
    gap: 8px;
  }
  h1 { margin: 0; }
  .grid {
    display: grid;
    grid-gap: 12px;
  }
  .card {
    border: 1px solid #e3e3e3;
    border-radius: 12px;
    padding: 12px;
    background: white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    white-space: pre-wrap;
  }
  .muted {
    color: #6b7280;
    font-size: 12px;
  }
  @media(min-width:700px) {
    .grid { grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
  }
  #refreshBtn {
    background: #007bff;
    color: white;
    border: none;
    padding: 8px 14px;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
    margin-left: 8px;
  }
  #refreshBtn:hover { background: #005dc3; }
  #refreshBtn:active { transform: scale(0.97); }
  #bilSelect {
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 14px;
    background: white;
    cursor: pointer;
    transition: border-color 0.2s;
  }
  #bilSelect:hover { border-color: #007bff; }

  /* Inloggning */
  .lock-overlay {
    position: fixed; inset: 0;
    background: rgba(250,250,250,.96);
    display: flex; align-items: center; justify-content: center;
    z-index: 9999;
  }
  .lock-card {
    width: min(420px,92vw);
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 14px;
    box-shadow: 0 10px 30px rgba(0,0,0,.08);
    padding: 20px;
  }
  .lock-title { margin: 0 0 8px 0; font-size: 20px; }
  .lock-sub { margin: 0 0 16px 0; font-size: 13px; color: #6b7280; }
  .lock-row { display: flex; gap: 8px; }
  .lock-input {
    flex: 1; border: 1px solid #d1d5db; border-radius: 10px;
    padding: 10px 12px; font-size: 16px;
  }
  .lock-btn {
    background: #0ea5e9; color: white; border: none; border-radius: 10px;
    padding: 10px 14px; font-size: 15px; cursor: pointer;
    transition: all 0.2s; white-space: nowrap;
  }
  .lock-btn:hover { background: #0284c7; }
  .lock-err { margin-top: 10px; color: #b00020; font-size: 13px; min-height: 1.2em; }
</style>
</head>
<body>

  <!-- Inloggning -->
  <div class="lock-overlay" id="lock">
    <div class="lock-card">
      <h2 class="lock-title">Logga in</h2>
      <p class="lock-sub">Ange l√∂senord f√∂r att visa Dagens turer.</p>
      <div class="lock-row">
        <input id="pin" class="lock-input" type="password" placeholder="L√∂senord">
        <button id="pinBtn" class="lock-btn">√ñppna</button>
      </div>
      <div id="lockErr" class="lock-err"></div>
    </div>
  </div>

  <header>
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
      <h1>Dagens turer</h1>
      <select id="bilSelect">
        <option value="all">Visa alla</option>
      </select>
      <button id="refreshBtn">üîÑ Uppdatera</button>
    </div>
    <div class="muted" id="stamp"></div>
  </header>

  <div class="grid" id="grid"></div>

<script>
/* ============================
   Enkel l√∂senordsinloggning
   ============================ */
const LOCK_PIN = 'kof123'; // <-- √§ndra till ditt eget l√∂senord
const LOCK_KEY = 'chaufforinfo-unlocked';
function isUnlocked() {
  return localStorage.getItem(LOCK_KEY) === 'true';
}
function unlock() {
  localStorage.setItem(LOCK_KEY, 'true');
  document.getElementById('lock').style.display = 'none';
  loadData();
}
document.getElementById('pinBtn').addEventListener('click', checkPin);
document.getElementById('pin').addEventListener('keydown', e => { if (e.key === 'Enter') checkPin(); });
function checkPin() {
  const val = document.getElementById('pin').value.trim();
  const err = document.getElementById('lockErr');
  if (val === LOCK_PIN) { unlock(); } else { err.textContent = 'Fel l√∂senord. F√∂rs√∂k igen.'; }
}
if (isUnlocked()) document.getElementById('lock').style.display = 'none';

/* ============================
   Datahantering & visning
   ============================ */
let cars = [];

async function loadData(){
  const grid = document.getElementById('grid');
  grid.innerHTML = '<p>Laddar...</p>';
  try {
    const res = await fetch('./data.json?v=' + Date.now(), { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();

    document.getElementById('stamp').textContent =
      'Senast uppdaterad: ' + (new Date(data.updated_at)).toLocaleString();

    if (Array.isArray(data.cars)) {
      cars = data.cars;
    } else if (Array.isArray(data.blocks)) {
      cars = data.blocks.map((b,i)=>({
        label: (b.split(/\n/)[5] || `Bil ${i+1}`),
        summary: b,
        details: []
      }));
    } else {
      cars = [];
    }

    const sel = document.getElementById('bilSelect');
    sel.innerHTML = '<option value="all">Visa alla</option>';
    cars.forEach((car,i)=>{
      const opt = document.createElement('option');
      opt.value = i;
      const label = car.label?.trim() || `Bil ${i+1}`;
      opt.textContent = label;
      sel.appendChild(opt);
    });
    sel.value = 'all';
    renderAll();
  } catch(e) {
    grid.innerHTML = '<p style="color:#b00020;">Kunde inte l√§sa data.json</p>';
    console.error(e);
  }
}

function renderAll() {
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  cars.forEach(renderCard);
}
function renderOne(idx) {
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  if (cars[idx]) renderCard(cars[idx]);
}

function renderCard(car) {
  const div = document.createElement('div');
  div.className = 'card';

  const pre = document.createElement('pre');
  pre.style.margin = '0 0 10px 0';
  pre.textContent = car.summary || '';
  div.appendChild(pre);

  if (Array.isArray(car.details) && car.details.length) {
    const hr = document.createElement('hr');
    hr.style.border = 'none';
    hr.style.borderTop = '1px solid #eee';
    hr.style.margin = '8px 0';
    div.appendChild(hr);

    const ul = document.createElement('ul');
    ul.style.margin = '0';
    ul.style.paddingLeft = '20px';
    car.details.forEach(line=>{
      const li = document.createElement('li');
      li.textContent = line;
      ul.appendChild(li);
    });
    div.appendChild(ul);
  }

  document.getElementById('grid').appendChild(div);
}

/* ============================
   H√§ndelser
   ============================ */
document.getElementById('refreshBtn').addEventListener('click', loadData);
document.getElementById('bilSelect').addEventListener('change', e=>{
  if (e.target.value === 'all') renderAll();
  else renderOne(parseInt(e.target.value,10));
});

/* ============================
   Init
   ============================ */
if (isUnlocked()) loadData();
</script>
</body>
</html>
