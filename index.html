<!doctype html>
<html lang="sv">
<head>
  <script>
(function () {
  var h = location.hash || "";
  if (/(invite_token|confirmation_token|recovery_token)=/i.test(h)) {
    try { sessionStorage.setItem('_nl_hash', h); } catch(e) {}
    // bygg en s√§ker absolut URL till /admin/ p√• samma origin
    var adminUrl = new URL('/admin/', window.location.origin).toString();
    location.replace(adminUrl);
  }
})();
</script>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>KOF ‚Äì Chauff√∂rportal</title>
<style>
:root{
  --brand:#0ea5e9; --brand-600:#0284c7;
  --blue:#007bff; --blue-700:#005dc3;
  --muted:#6b7280; --card:#fff; --bg:#fafafa; --border:#e5e7eb;
  --shadow:0 1px 3px rgba(0,0,0,.05); --shadow-lg:0 8px 24px rgba(0,0,0,.10);
}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:#111827}
a{color:inherit;text-decoration:none}
<script>
(function () {
  var h = location.hash || "";
  if (/#(invite_token|confirmation_token|recovery_token)=/i.test(h)) {
    location.replace("/admin/" + h);   // skicka vidare token till admin
  }
})();
</script>


/* -------- TOPPMENY -------- */
.topbar{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,#fff,rgba(255,255,255,.97));border-bottom:1px solid var(--border);backdrop-filter:saturate(180%) blur(6px)}
.topbar .wrap{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:16px;padding:10px 16px}
.brand{font-weight:700;letter-spacing:.2px;color:var(--brand);font-size:18px}
.nav{display:flex;gap:8px;align-items:center}
.nav a{padding:8px 12px;border-radius:10px;transition:background .15s ease,color .15s ease}
.nav a:hover{background:#f3f4f6}
.nav a.active{background:var(--brand);color:#fff}

/* -------- MOBILMENY -------- */
.mobile-launcher{display:none;max-width:1200px;margin:12px auto 0;padding:0 16px}
.ml-wrap{background:#f2f3f7;border:1px solid #e9e9ee;border-radius:18px;padding:14px;display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.ml-item{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;padding:8px 4px;border-radius:12px;transition:transform .08s ease, background .15s ease}
.ml-item:active{transform:scale(0.98)}
.ml-item.active{background:#e9f6fe}
.micon{width:48px;height:48px;border-radius:50%;background:#fff;display:grid;place-items:center;box-shadow:0 1px 3px rgba(0,0,0,.08);font-size:24px;user-select:none}
.ml-label{font-size:13px;color:#111827}
@media(max-width:700px){ .topbar .nav{display:none} .mobile-launcher{display:block} }

/* -------- SIDLAYOUT -------- */
.page{max-width:1200px;margin:16px auto;padding:0 16px 24px}
header.pagehead{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:12px}
h1{margin:0}
.grid{display:grid;grid-gap:12px}
@media(min-width:700px){.grid{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}}

.card{border:1px solid var(--border);border-radius:12px;background:var(--card);box-shadow:var(--shadow);overflow:hidden;cursor:pointer;transition:box-shadow .15s ease}
.card:hover{box-shadow:0 3px 10px rgba(0,0,0,.08)}
.card-header{display:flex;align-items:center;gap:10px;padding:12px}
.chev{transition:transform .18s ease;user-select:none;font-size:16px}
.card.expanded .chev{transform:rotate(90deg)}
.summary{white-space:pre-wrap;margin:0;flex:1}

.divider{border:none;border-top:1px solid #eee;margin:0}
.details{display:none;padding:10px 14px 12px}
.card.expanded .details{display:block}
.details ul{margin:8px 0 0 0;padding-left:20px;line-height:1.4}
.details li{margin-bottom:6px}

/* ---- Butiksrad + pallrad ---- */
.details li.store{
  margin-bottom:2px;
  font-weight:600;
  color:#111827;
}
.details li.qty{
  margin-bottom:12px;      /* luft efter butik+pall-par */
  color:#4b5563;           /* mjuk gr√• */
}

/* ---- Nytt: Frys/Kyl/Kol som ETT block ---- */
.details li.qtyblock{
  margin: 8px 0 8px 0;     /* luft runt hela blocket */
}
.details li.qtyblock > div{
  margin: 0;               /* inga mellanrum mellan raderna */
  line-height: 1.3;
}

/* ---- Totalt & notiser ---- */
.details li.total{ margin-bottom:6px; }
.details li.note{  margin-top:6px;  }

.muted{color:var(--muted);font-size:12px}
.btn{background:var(--blue);color:#fff;border:none;padding:8px 14px;border-radius:8px;font-size:14px;cursor:pointer;transition:all .2s}
.btn:hover{background:var(--blue-700)}
select.control{padding:8px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;background:#fff;cursor:pointer;transition:border-color .2s}
select.control:hover{border-color:var(--blue)}

/* ---- PIN-l√•s ---- */
.lock-overlay{position:fixed;inset:0;background:rgba(250,250,250,.96);display:flex;align-items:center;justify-content:center;z-index:9999}
.lock-card{width:min(420px,92vw);background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow-lg);padding:20px}
.lock-title{margin:0 0 8px 0;font-size:20px}
.lock-sub{margin:0 0 16px 0;font-size:13px;color:var(--muted)}
.lock-row{display:flex;gap:8px}
.lock-input{flex:1;border:1px solid #d1d5db;border-radius:10px;padding:10px 12px;font-size:16px}
.lock-btn{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-size:15px;cursor:pointer;transition:all .2s;white-space:nowrap}
.lock-btn:hover{background:var(--brand-600)}
.lock-err{margin-top:10px;color:#b00020;font-size:13px;min-height:1.2em}

/* ---- √ñvriga sektioner ---- */
.hero{background:linear-gradient(180deg,#fff,#f8fafc);border:1px solid var(--border);border-radius:16px;padding:24px;box-shadow:var(--shadow)}
.hero h2{margin:0 0 8px}
.hero p{margin:6px 0;color:#374151}

.news{display:grid;grid-gap:12px}
@media(min-width:700px){.news{grid-template-columns:repeat(auto-fit,minmax(320px,1fr))}}
.news .item{border:1px solid var(--border);border-radius:12px;background:#fff;box-shadow:var(--shadow);padding:14px}
.news .item h3{margin:0 0 6px}
.news .meta{font-size:12px;color:#6b7280;margin-bottom:8px}
table.contacts{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden;box-shadow:var(--shadow)}
table.contacts th,table.contacts td{padding:10px;border-bottom:1px solid #eee;text-align:left}
table.contacts th{background:#f9fafb;font-weight:600;font-size:14px}
</style>
</head>
<body>

<!-- TOPPMENY (desktop) -->
<div class="topbar">
  <div class="wrap">
    <div class="brand">KOF ‚Äì Chauff√∂rportal</div>
    <nav class="nav">
      <a href="#/home" id="link-home" class="active">Home</a>
      <a href="#/dagab" id="link-dagab">Dagab</a>
      <a href="#/nyheter" id="link-nyheter">Nyheter</a>
      <a href="#/kontakter" id="link-kontakter">Kontakter</a>
    </nav>
  </div>
</div>

<!-- MOBILMENY (launcher) -->
<div class="mobile-launcher">
  <div class="ml-wrap">
    <a class="ml-item" href="#/home" id="ml-home"><span class="micon">üè†</span><span class="ml-label">Home</span></a>
    <a class="ml-item" href="#/dagab" id="ml-dagab"><span class="micon">üöö</span><span class="ml-label">Dagab</span></a>
    <a class="ml-item" href="#/nyheter" id="ml-nyheter"><span class="micon">üì∞</span><span class="ml-label">Nyheter</span></a>
    <a class="ml-item" href="#/kontakter" id="ml-kontakter"><span class="micon">üë•</span><span class="ml-label">Kontakter</span></a>
  </div>
</div>

<!-- SIDOR -->
<main id="app" class="page">
  <!-- Home -->
  <section id="page-home" data-page>
    <div class="hero">
      <h2>V√§lkommen!</h2>
      <p>H√§r samlar vi information f√∂r v√•ra chauff√∂rer. Anv√§nd menyn ovan.</p>
    </div>
  </section>

  <!-- Dagab -->
  <section id="page-dagab" data-page hidden>
    <!-- (valbart) PIN-l√•s -->
    <div class="lock-overlay" id="lock" style="display:none">
      <div class="lock-card">
        <h2 class="lock-title">Logga in</h2>
        <p class="lock-sub">Ange l√∂senord f√∂r att visa Dagens turer.</p>
        <div class="lock-row">
          <input id="pin" class="lock-input" type="password" placeholder="L√∂senord">
          <button id="pinBtn" class="lock-btn">√ñppna</button>
        </div>
        <div id="lockErr" class="lock-err"></div>
      </div>
    </div>

    <header class="pagehead">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <h1>Dagens turer</h1>
        <select id="bilSelect" class="control"><option value="all">Visa alla</option></select>
        <button id="refreshBtn" class="btn">üîÑ Uppdatera</button>
      </div>
      <div class="muted" id="stamp"></div>
    </header>
    <div class="grid" id="grid"></div>
  </section>

  <!-- Nyheter -->
  <section id="page-nyheter" data-page hidden>
    <header class="pagehead"><h1>Nyheter</h1></header>
    <div class="news" id="newsList"></div>
  </section>

  <!-- Kontakter -->
  <section id="page-kontakter" data-page hidden>
    <header class="pagehead"><h1>Kontakter</h1></header>
    <div style="overflow:auto">
      <table class="contacts" id="contactsTable">
        <thead><tr><th>Namn</th><th>Roll</th><th>Telefon</th><th>E-post</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<script>
/* -------- ROUTER -------- */
function setActive(hash){
  document.querySelectorAll('.nav a').forEach(a=>a.classList.remove('active'));
  const d=document.querySelector(`.nav a[href="${hash}"]`); if(d) d.classList.add('active');
  document.querySelectorAll('.ml-item').forEach(a=>a.classList.remove('active'));
  const m=document.querySelector(`.ml-item[href="${hash}"]`); if(m) m.classList.add('active');
}
function showPage(id){
  document.querySelectorAll('[data-page]').forEach(s=>s.hidden=true);
  document.getElementById(id).hidden=false;
}
function handleRoute(){
  const h=location.hash||'#/home';
  setActive(h);
  if(h==='#/dagab'){ showPage('page-dagab'); ensureDagabReady(); }
  else if(h==='#/nyheter'){ showPage('page-nyheter'); renderNews(); }
  else if(h==='#/kontakter'){ showPage('page-kontakter'); renderContacts(); }
  else { showPage('page-home'); }
}
window.addEventListener('hashchange',handleRoute);

/* -------- PIN (Dagab) -------- */
const REQUIRE_LOGIN=false;     // s√§tt true om Dagab ska kr√§va PIN
const LOCK_PIN='kof123';
const LOCK_KEY='chaufforinfo-unlocked';
function isUnlocked(){ return localStorage.getItem(LOCK_KEY)==='true'; }
function unlock(){ localStorage.setItem(LOCK_KEY,'true'); document.getElementById('lock').style.display='none'; loadData(); }
function setupLock(){
  if(!REQUIRE_LOGIN){ document.getElementById('lock').style.display='none'; loadData(); return; }
  document.getElementById('pinBtn').addEventListener('click',checkPin);
  document.getElementById('pin').addEventListener('keydown',e=>{ if(e.key==='Enter') checkPin(); });
  if(isUnlocked()){ document.getElementById('lock').style.display='none'; loadData(); }
  else document.getElementById('lock').style.display='flex';
}
function checkPin(){
  if(document.getElementById('pin').value.trim()===LOCK_PIN) unlock();
  else document.getElementById('lockErr').textContent='Fel l√∂senord. F√∂rs√∂k igen.';
}

/* -------- DAGAB: h√§mta & rendera data.json -------- */
let cars=[];

async function loadData(){
  const grid=document.getElementById('grid');
  grid.innerHTML='<p>Laddar...</p>';
  try{
    const res=await fetch('./data.json?v='+Date.now(),{cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data=await res.json();

    document.getElementById('stamp').textContent=
      'Senast uppdaterad: '+(new Date(data.updated_at)).toLocaleString();

    if(Array.isArray(data.cars)){
      cars=data.cars;
    }else if(Array.isArray(data.blocks)){
      cars=data.blocks.map((b,i)=>({label:(b.split(/\n/)[5]||`Bil ${i+1}`),summary:b,details:[]}));
    }else{
      cars=[];
    }

    const sel=document.getElementById('bilSelect');
    sel.innerHTML='<option value="all">Visa alla</option>';
    cars.forEach((car,i)=>{
      const opt=document.createElement('option');
      opt.value=i;
      opt.textContent=(car.label&&car.label.trim())?car.label:`Bil ${i+1}`;
      sel.appendChild(opt);
    });
    sel.value='all';

    renderAll();
  }catch(e){
    grid.innerHTML='<p style="color:#b00020;">Kunde inte l√§sa data.json</p>';
    console.error(e);
  }
}

function buildCard(car,idx,expanded=false){
  const card=document.createElement('div');
  card.className='card'+(expanded?' expanded':'');

  // header
  const header=document.createElement('div'); header.className='card-header';
  const chev=document.createElement('span');  chev.className='chev'; chev.textContent='‚ñ∂';
  const pre=document.createElement('pre');    pre.className='summary'; pre.textContent=car.summary||'';
  header.append(chev,pre); card.append(header);

  // details
  const hasDetails=Array.isArray(car.details)&&car.details.length>0;
  if(hasDetails){
    card.append(Object.assign(document.createElement('hr'),{className:'divider'}));
    const details=document.createElement('div'); details.className='details';
    const ul=document.createElement('ul');

    for(let i=0;i<car.details.length;i++){
      const line=car.details[i];
      const lower=line.toLowerCase().trim();

      // Grupp: Frys + Kyl + Kol -> ETT li
      if(/^frys\s*:/.test(lower)){
        const group=[line];
        const n1=car.details[i+1]||'', n2=car.details[i+2]||'';
        if(/^\s*kyl\s*:/.test(String(n1).toLowerCase())){ group.push(n1); i++; }
        if(/^\s*kol\s*:/.test(String(n2).toLowerCase())){ group.push(n2); i++; }
        const li=document.createElement('li');
        li.className='qtyblock';
        li.innerHTML=group.map(t=>`<div>${t}</div>`).join('');
        ul.append(li);
        continue;
      }

      // Vanlig rad (inkl. butik/pall/total/notes)
      const li=document.createElement('li'); li.textContent=line;

      const isQty = /\b(frys|kyl|kol)\b/.test(lower);
      const isTotal = lower.startsWith('totalt');
      const isNote = lower.startsWith('gl√∂m') || lower.startsWith('glom');

      if(isQty)   li.classList.add('qty');
      if(isTotal) li.classList.add('total');
      if(isNote)  li.classList.add('note');

      // markera butiksrad om n√§sta rad √§r qty
      const next=car.details[i+1];
      if(next){
        const nextIsQty=/\b(frys|kyl|kol)\b/.test(String(next).toLowerCase());
        if(!isQty && !isTotal && !isNote && nextIsQty) li.classList.add('store');
      }

      ul.append(li);
    }

    details.append(ul);
    card.append(details);
  }

  // expand/collapse
  card.addEventListener('click',e=>{
    if(e.target.closest('button,select')) return;
    if(!card.querySelector('.details'))   return;
    card.classList.toggle('expanded');
  });

  return card;
}

function renderAll(){
  const g=document.getElementById('grid');
  g.innerHTML='';
  cars.forEach((c,i)=>g.append(buildCard(c,i,false)));
}
function renderOne(i){
  const g=document.getElementById('grid');
  g.innerHTML='';
  if(cars[i]) g.append(buildCard(cars[i],i,true));
}

function bindDagabControls(){
  const btn=document.getElementById('refreshBtn');
  const sel=document.getElementById('bilSelect');
  if(!btn._bound){ btn.addEventListener('click',loadData); btn._bound=true; }
  if(!sel._bound){
    sel.addEventListener('change',e=>{
      if(e.target.value==='all') renderAll();
      else renderOne(parseInt(e.target.value,10));
    });
    sel._bound=true;
  }
}
let dagabInitialized=false;
function ensureDagabReady(){
  if(dagabInitialized) return;
  dagabInitialized=true;
  bindDagabControls();
  setupLock(); // laddar data direkt om PIN ej kr√§vs
}

/* -------- NYHETER & KONTAKTER -------- */
import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js").then(async ({ initializeApp }) => {
  const { getFirestore, collection, getDocs, orderBy, limit, query } =
    await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");

  const firebaseConfig = {
    apiKey: "AIzaSyDUPTHaLl4j_Wfp4kK62uBOQSotdl0QOjc",
    authDomain: "kofnord-1e371.firebaseapp.com",
    projectId: "kofnord-1e371",
    storageBucket: "kofnord-1e371.firebasestorage.app",
    messagingSenderId: "559491880457",
    appId: "1:559491880457:web:b57bbf0bd1bb11ac3f0ad8"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ====== Ladda full nyhetslista (Nyheter-sidan) ======
  async function renderNews() {
    const box = document.getElementById("newsList");
    if (!box) return;
    box.innerHTML = '<p class="muted">Laddar nyheter‚Ä¶</p>';
    try {
      const q = query(collection(db, "news"), orderBy("date", "desc"));
      const snap = await getDocs(q);
      if (snap.empty) {
        box.innerHTML = '<p class="muted">Inga nyheter √§nnu.</p>';
        return;
      }

      box.innerHTML = "";
      snap.forEach(doc => {
        const n = doc.data();
        const div = document.createElement("div");
        div.className = "item";
        const d = n.date ? new Date(n.date).toLocaleDateString() : "";
        div.innerHTML = `
          <h3>${n.title || ""}</h3>
          <div class="meta">${d}</div>
          <p>${(n.body || "").replace(/\n/g, "<br>")}</p>`;
        box.appendChild(div);
      });
    } catch (err) {
      console.error(err);
      box.innerHTML = '<p style="color:#b00020;">Kunde inte l√§sa nyheter.</p>';
    }
  }

  // ====== Ladda senaste 3 nyheter (startsidan) ======
  async function renderLatestNews() {
    const home = document.querySelector("#page-home .hero");
    if (!home) return;

    const section = document.createElement("section");
    section.id = "latest-news";
    section.style.marginTop = "30px";
    section.innerHTML = `
      <h3>üì∞ Senaste nytt</h3>
      <div id="latest-container"><p class="muted">Laddar nyheter...</p></div>
    `;
    home.appendChild(section);

    const container = section.querySelector("#latest-container");

    try {
      const q = query(collection(db, "news"), orderBy("date", "desc"), limit(3));
      const snap = await getDocs(q);
      if (snap.empty) {
        container.innerHTML = "<p class='muted'>Inga nyheter √§nnu.</p>";
        return;
      }

      container.innerHTML = "";
      snap.forEach(doc => {
        const n = doc.data();
        const div = document.createElement("div");
        div.style.borderBottom = "1px solid #eee";
        div.style.marginBottom = "8px";
        div.style.paddingBottom = "6px";
        div.innerHTML = `
          <strong>${n.title}</strong><br>
          <small style="color:#6b7280">${n.date}</small><br>
          <span>${(n.body || "").split("\n")[0]}...</span>
        `;
        container.appendChild(div);
      });
    } catch (e) {
      console.error(e);
      container.innerHTML = "<p style='color:#b00020;'>Kunde inte l√§sa nyheter.</p>";
    }
  }

  // ====== Kontakter (of√∂r√§ndrat) ======
  const CONTACTS = [
    { name: "Transportledningen", role: "Planering", phone: "+46 90 123456", email: "plan@kof.se" },
    { name: "IT-support", role: "PDA/√Ötkomst", phone: "+46 90 765432", email: "it@kof.se" }
  ];

  function renderContacts() {
    const tb = document.querySelector("#contactsTable tbody");
    if (!tb) return;
    tb.innerHTML = "";
    CONTACTS.forEach(c => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${c.name}</td>
        <td>${c.role}</td>
        <td><a href="tel:${c.phone.replace(/\s+/g, "")}">${c.phone}</a></td>
        <td><a href="mailto:${c.email}">${c.email}</a></td>`;
      tb.appendChild(tr);
    });
  }

  /* -------- Start -------- */
  window.renderNews = renderNews;
  window.renderContacts = renderContacts;
  renderLatestNews(); // k√∂r direkt vid start
});

