<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>KOF ‚Äì Chauff√∂rportal</title>

<style>
:root{
  --border:#e5e7eb;
  --shadow:0 1px 3px rgba(0,0,0,.05);
  --wrap:1000px;
  --ink:#0f172a;
  --muted:#475569;
  --blue:#0284c7;
  --blue-ink:#0369a1;
  --blue-100:#e0f2fe;
  --chip-bg:#f8fafc;
}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f9fafb;color:var(--ink)}

/* Topbar */
.topbar{
  background:#fff;border-bottom:1px solid var(--border);
  position:sticky;top:0;z-index:10;transition:box-shadow .18s ease,border-color .18s ease
}
.topbar.scrolled{box-shadow:0 6px 18px rgba(2,8,23,.06);border-color:#eef2f7}
.topbar .wrap{
  max-width:var(--wrap);margin:0 auto;padding:10px 16px;
  display:flex;align-items:center;justify-content:space-between;gap:14px
}
.brand{margin:0;font-size:18px;color:var(--blue);font-weight:700;letter-spacing:.2px}

/* Desktop nav ‚Äì pill style */
.nav{
  display:flex;gap:6px;background:var(--chip-bg);padding:6px;border:1px solid var(--border);
  border-radius:9999px;box-shadow:var(--shadow)
}
.nav a{
  --pad-x:14px;text-decoration:none;color:#334155;padding:8px var(--pad-x);border-radius:9999px;
  font-size:14px;font-weight:600;line-height:1;transition:background .15s,box-shadow .15s,color .15s,transform .04s
}
.nav a:hover{background:#eef2f7}
.nav a:active{transform:translateY(1px)}
.nav a.active{background:var(--blue-100);color:var(--blue-ink);box-shadow:inset 0 0 0 1px #bae6fd}
.nav a:focus-visible{outline:2px solid #93c5fd;outline-offset:2px}

/* Mobil-ikon-meny */
.mobile-launcher{display:none}
@media(max-width:700px){
  .nav{display:none}
  .mobile-launcher{display:block}
}
.mobile-launcher .wrap{max-width:var(--wrap);margin:12px auto 0;padding:0 16px}
.ml-grid{
  background:#f2f3f7;border:1px solid #e9e9ee;border-radius:18px;padding:14px;
  display:grid;grid-template-columns:repeat(4,1fr);gap:8px
}
.ml-item{display:flex;flex-direction:column;align-items:center;gap:6px;padding:10px 6px;border-radius:12px;
  text-decoration:none;color:#111;transition:transform .06s, box-shadow .15s, background .15s}
.ml-item:hover{background:#fff;box-shadow:0 3px 10px rgba(0,0,0,.08)}
.ml-item:active{transform:translateY(1px)}
.micon{width:48px;height:48px;border-radius:12px;background:#fff;display:grid;place-items:center;box-shadow:0 1px 3px rgba(0,0,0,.08);font-size:24px}
.ml-label{font-size:13px;color:#111827;font-weight:600}

/* Sidlayout */
.page{max-width:var(--wrap);margin:16px auto;padding:0 16px 24px}
.page h2{margin:0}

/* Dagab ‚Äì verktygsrad */
.tools{
  display:flex;align-items:center;gap:12px;justify-content:space-between;margin:8px 0 12px
}
.tools-left{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.tools-right{margin-left:auto;color:var(--muted);font-size:12px}

/* Knapp */
.btn{
  appearance:none;border:1px solid #0273ad;background:var(--blue);color:#fff;
  font-weight:700;border-radius:10px;padding:8px 12px;cursor:pointer;box-shadow:var(--shadow);
  transition:filter .15s, transform .04s
}
.btn:hover{filter:brightness(1.05)}
.btn:active{transform:translateY(1px)}
.btn:disabled{opacity:.6;cursor:progress}

/* Kortlayout (Dagab) */
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(270px,1fr));gap:16px;margin-top:10px}
.card{border:1px solid var(--border);border-radius:12px;background:#fff;box-shadow:var(--shadow);
  overflow:hidden;cursor:pointer;transition:box-shadow .15s}
.card:hover{box-shadow:0 3px 10px rgba(0,0,0,.08)}
.card-header{display:flex;align-items:center;gap:10px;padding:12px}
.chev{transition:transform .18s;user-select:none;font-size:16px}
.card.expanded .chev{transform:rotate(90deg)}
.summary{white-space:pre-wrap;margin:0;flex:1;font-size:14px;line-height:1.3}
.divider{border:none;border-top:1px solid #eee;margin:0}
.details{display:none;padding:10px 14px 12px}
.card.expanded .details{display:block}
.details ul{margin:8px 0 0 0;padding-left:20px;line-height:1.4}
.details li{margin-bottom:6px}
.details li.store{font-weight:600;color:#111827}

/* MELLANRUM mellan pallantal och n√§sta butik */
.details li.qty{color:#4b5563;margin-bottom:8px}
.details li.total{font-weight:700;margin-top:4px;margin-bottom:8px}
.details li.note{margin-top:6px;color:#991b1b}
.muted{color:#6b7280;font-size:13px}

/* Nyheter */
.news{display:grid;grid-template-columns:1fr;gap:12px;max-width:720px;margin:0 auto}
.news .item{border:1px solid var(--border);border-radius:12px;background:#fff;box-shadow:var(--shadow);padding:16px;cursor:pointer;transition:box-shadow .15s}
.news .item:hover{box-shadow:0 3px 10px rgba(0,0,0,.08)}
.news .item h3{margin:0 0 6px}
.news .meta{font-size:12px;color:#6b7280;margin-bottom:8px}
.news .more{color:var(--blue);font-weight:600;margin-top:6px;user-select:none}
.news .item.collapsed .more::after{content:" ‚Äì klicka f√∂r att l√§sa mer"}
.news .item.expanded .more::after{content:" ‚Äì klicka f√∂r att visa mindre"}
.highlight{animation:flash 1.3s ease-out 1}
@keyframes flash{0%{box-shadow:0 0 0 0 rgba(2,132,199,.45)}40%{box-shadow:0 0 0 6px rgba(2,132,199,.15)}100%{box-shadow:0 1px 3px rgba(0,0,0,.05)}}

/* Nyhetsl√§nkar */
.news-links{list-style:none;padding:0;margin:12px 0 0}
.news-links li{margin:0 0 10px}
.news-links a{display:block;background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px 14px;box-shadow:var(--shadow);text-decoration:none;color:#111;transition:box-shadow .15s}
.news-links a:hover{box-shadow:0 3px 10px rgba(0,0,0,.08)}
.news-links .title{font-weight:600}
.news-links .meta{font-size:12px;color:#6b7280;margin-top:4px}

/* Kontakter */
.contacts-acc{display:grid;gap:10px}
.contact-card{border:1px solid var(--border);border-radius:12px;background:#fff;box-shadow:var(--shadow);overflow:hidden}
.contact-head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;cursor:pointer}
.contact-head .name{font-weight:600}
.contact-head .chev{transition:transform .18s ease;font-size:16px}
.contact-card.open .contact-head .chev{transform:rotate(90deg)}
.contact-body{display:none;padding:0 14px 12px 14px}
.contact-card.open .contact-body{display:block}
.contact-body .row{margin:8px 0;color:#374151}
.contact-body a{color:#0ea5e9;text-decoration:none}

/* Mindre r√∂relse */
@media (prefers-reduced-motion: reduce){.chev,.nav a,.ml-item,.topbar{transition:none}}
</style>
</head>
<body>

<header class="topbar" id="topbar">
  <div class="wrap">
    <h1 class="brand">KOF ‚Äì Chauff√∂rportal</h1>
    <nav class="nav" aria-label="Huvudmeny">
      <a href="#/home" id="link-home">Home</a>
      <a href="#/dagab" id="link-dagab">Dagab</a>
      <a href="#/nyheter" id="link-nyheter">Nyheter</a>
      <a href="#/kontakter" id="link-kontakter">Kontakter</a>
    </nav>
  </div>
</header>

<div class="mobile-launcher" aria-label="Snabbmeny">
  <div class="wrap">
    <div class="ml-grid">
      <a class="ml-item" href="#/home"><span class="micon">üè†</span><span class="ml-label">Home</span></a>
      <a class="ml-item" href="#/dagab"><span class="micon">üöö</span><span class="ml-label">Dagab</span></a>
      <a class="ml-item" href="#/nyheter"><span class="micon">üì∞</span><span class="ml-label">Nyheter</span></a>
      <a class="ml-item" href="#/kontakter"><span class="micon">üë•</span><span class="ml-label">Kontakter</span></a>
    </div>
  </div>
</div>

<main>
  <section id="page-home" class="page" data-page>
    <h2>V√§lkommen till KOF-Nords Chauff√∂rsportal</h2>
    <p>H√§r ser du de senaste uppdateringarna. Klicka f√∂r att l√§sa hela nyheten under <em>Nyheter</em>.</p>
    <h3 style="margin-top:18px">üì∞ Senaste nytt</h3>
    <ul id="latestNewsLinks" class="news-links"></ul>
  </section>

  <section id="page-dagab" class="page" data-page hidden>
    <div class="tools">
      <div class="tools-left">
        <h2>Dagens turer</h2>
        <button id="btnRefresh" class="btn">Uppdatera</button>
      </div>
      <div class="tools-right">
        <span id="status"> </span>
      </div>
    </div>
    <div id="grid" class="grid"></div>
  </section>

  <section id="page-nyheter" class="page" data-page hidden>
    <h2>Nyheter</h2>
    <div id="newsList" class="news"></div>
  </section>

  <section id="page-kontakter" class="page" data-page hidden>
    <h2>Kontakter</h2>
    <div id="contactsList" class="contacts-acc"></div>
  </section>
</main>

<script type="module">
/* ===== ROUTING ===== */
function setActive(hash){
  document.querySelectorAll('.nav a').forEach(a=>{
    a.classList.remove('active');
    a.removeAttribute('aria-current');
  });
  const clean = hash.split('/').slice(0,2).join('/');
  const link = document.querySelector(`.nav a[href="${clean}"]`);
  if(link){ link.classList.add('active'); link.setAttribute('aria-current','page'); }
}
function showPage(id){
  document.querySelectorAll('[data-page]').forEach(s=>s.hidden=true);
  document.getElementById(id).hidden=false;
}
function handleRoute(){
  const h = location.hash || '#/home';
  setActive(h);
  const parts = h.split('/');
  const route = parts[1] || 'home';
  const param = parts[2] || null;
  if(route==='dagab'){ showPage('page-dagab'); ensureDagabReady(); }
  else if(route==='nyheter'){ showPage('page-nyheter'); renderNewsAll(param); }
  else if(route==='kontakter'){ showPage('page-kontakter'); renderContacts(); }
  else { showPage('page-home'); renderLatestNewsLinks(); }
}
window.addEventListener('hashchange', handleRoute);

/* Scrollskugga */
const topbar=document.getElementById('topbar');
function onScroll(){ topbar.classList.toggle('scrolled', window.scrollY>2); }
onScroll();
window.addEventListener('scroll', onScroll, {passive:true});

/* ===== DAGAB ===== */
const DATA_URL="https://therulest.github.io/kof-chaufforinfo/data.json";
let dagabInitialized=false;
const btnRefresh = () => document.getElementById('btnRefresh');
const statusEl   = () => document.getElementById('status');

function ensureDagabReady(){
  if(!dagabInitialized){
    dagabInitialized=true;
    attachRefresh();
    loadDagab();
  }
}
function attachRefresh(){
  const b=btnRefresh();
  if(!b) return;
  b.addEventListener('click', ()=> loadDagab(true));
}

async function loadDagab(manual=false){
  const grid=document.getElementById('grid');
  const b=btnRefresh();
  const s=statusEl();
  if(manual && b){ b.disabled=true; b.textContent='Uppdaterar‚Ä¶'; }
  grid.innerHTML = manual ? grid.innerHTML : '<p>Laddar‚Ä¶</p>';
  try{
    const res=await fetch(DATA_URL+'?v='+Date.now(),{cache:'no-store'});
    const data=await res.json();
    buildCards(data);
    const t=new Date(data.updated_at||Date.now());
    if(s) s.textContent='Senast uppdaterad: '+t.toLocaleString('sv-SE');
  }catch(e){
    grid.innerHTML='<p style="color:#b00020">Fel vid h√§mtning.</p>';
  }finally{
    if(manual && b){ b.disabled=false; b.textContent='Uppdatera'; }
  }
}

function buildCards(data){
  const grid=document.getElementById('grid');
  grid.innerHTML='';
  (data.cars||[]).forEach((car,i)=>grid.append(buildCard(car,i,false)));
}

function buildCard(car,idx,expanded){
  const card=document.createElement('div');
  card.className='card'+(expanded?' expanded':'');
  const summaryText=String(car.summary||'');
  const lines=summaryText.split(/\r?\n/);
  const head=lines.slice(0,6);
  const details=Array.isArray(car.details)&&car.details.length?car.details.map(String):lines.slice(6);

  const header=document.createElement('div');header.className='card-header';
  const chev=document.createElement('span');chev.className='chev';chev.textContent='‚ñ∂';
  const pre=document.createElement('pre');pre.className='summary';pre.textContent=head.join('\n');
  header.append(chev,pre);card.append(header);

  if(details.length){
    card.append(Object.assign(document.createElement('hr'),{className:'divider'}));
    const d=document.createElement('div');d.className='details';
    const ul=document.createElement('ul');
    for(let i=0;i<details.length;i++){
      const line=String(details[i]);
      const lower=line.toLowerCase().trim();
      const li=document.createElement('li');
      li.textContent=line;

      if(lower.startsWith('gl√∂m')) li.classList.add('note');
      if(/^(frys|kyl|kol|totalt)\s*:/i.test(line)){
        if(/^totalt\s*:/i.test(line)) li.classList.add('total');
        else li.classList.add('qty');
      }
      if(/(\d+)\s*(FRYS|KYL|KOL)/i.test(line)) li.classList.add('qty');

      ul.append(li);
    }
    d.append(ul);card.append(d);
  }
  card.addEventListener('click',()=>card.classList.toggle('expanded'));
  return card;
}
function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

/* ===== FIREBASE ===== */
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {getFirestore,collection,getDocs,orderBy,limit,query} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
const firebaseConfig={
  apiKey:"AIzaSyDUPTHaLl4j_Wfp4kK62uBOQSotdl0QOjc",
  authDomain:"kofnord-1e371.firebaseapp.com",
  projectId:"kofnord-1e371",
  storageBucket:"kofnord-1e371.appspot.com",
  messagingSenderId:"559491880457",
  appId:"1:559491880457:web:b57bbf0bd1bb11ac3f0ad8"
};
const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

/* ===== HOME ‚Äì senaste nyheterna ===== */
let latestRendered=false;
async function renderLatestNewsLinks(){
  if(latestRendered)return;
  const list=document.getElementById('latestNewsLinks');
  list.innerHTML='<li class="muted">Laddar nyheter‚Ä¶</li>';
  try{
    const qy=query(collection(db,'news'),orderBy('date','desc'),limit(3));
    const snap=await getDocs(qy);
    list.innerHTML='';
    snap.forEach(d=>{
      const n=d.data();
      const dstr=n.date?new Date(n.date).toLocaleDateString('sv-SE'):'';
      const preview=(n.body||'').split('\n')[0];
      const li=document.createElement('li');
      li.innerHTML=`<a href="#/nyheter/${d.id}"><div class="title">${escapeHtml(n.title||'')}</div><div class="meta">${dstr}${preview?' ‚Ä¢ '+escapeHtml(preview):''}</div></a>`;
      list.appendChild(li);
    });
    latestRendered=true;
  }catch(e){list.innerHTML='<li style="color:#b00020">Kunde inte l√§sa nyheter.</li>'; }
}

/* ===== NYHETER ‚Äì 200 tecken + expandering ===== */
function truncateText(txt,n=200){const s=String(txt||"");return s.length<=n?s:s.slice(0,n).trimEnd()+"‚Ä¶";}
let newsLoaded=false;
async function renderNewsAll(targetId=null){
  const box=document.getElementById('newsList');
  if(!newsLoaded){box.innerHTML='<p class="muted">Laddar nyheter‚Ä¶</p>';}
  try{
    if(!newsLoaded){
      const qy=query(collection(db,'news'),orderBy('date','desc'));
      const snap=await getDocs(qy);
      box.innerHTML='';
      snap.forEach(docSnap=>{
        const n=docSnap.data();
        const full=(n.body||'');
        const shortText=truncateText(full,200);
        const div=document.createElement('div');
        div.className='item collapsed';
        div.id='news-'+docSnap.id;
        div.dataset.full=full;
        div.dataset.short=shortText;
        div.innerHTML=`
          <h3>${escapeHtml(n.title||'')}</h3>
          <div class="meta">${n.date?new Date(n.date).toLocaleDateString('sv-SE'):''}</div>
          <p class="body">${escapeHtml(shortText).replace(/\n/g,'<br>')}</p>
          <div class="more">L√§s mer</div>`;
        div.addEventListener('click',()=>{
          const body=div.querySelector('.body');
          const expanded=div.classList.toggle('expanded');
          div.classList.toggle('collapsed',!expanded);
          body.innerHTML=expanded
            ?escapeHtml(div.dataset.full).replace(/\n/g,'<br>')
            :escapeHtml(div.dataset.short).replace(/\n/g,'<br>');
        });
        box.append(div);
      });
      newsLoaded=true;
    }
    if(targetId){
      const el=document.getElementById('news-'+targetId);
      if(el){el.classList.add('highlight');setTimeout(()=>el.classList.remove('highlight'),1500);el.scrollIntoView({behavior:'smooth',block:'start'});}
    }
  }catch(e){box.innerHTML='<p style="color:#b00020">Kunde inte l√§sa nyheter.</p>'; }
}

/* ===== KONTAKTER ‚Äì Accordion ===== */
let contactsLoaded=false;
async function renderContacts(){
  const box=document.getElementById('contactsList');
  if(!contactsLoaded){box.innerHTML='<div class="muted">Laddar kontakter‚Ä¶</div>';}
  try{
    if(!contactsLoaded){
      const qy=query(collection(db,'contacts'),orderBy('sort','asc'));
      const snap=await getDocs(qy);
      box.innerHTML='';
      snap.forEach(d=>{
        const c=d.data();
        const card=document.createElement('div');
        card.className='contact-card';
        card.innerHTML=`
          <div class="contact-head">
            <span class="name">${escapeHtml(c.name||'')}</span>
            <span class="chev">‚ñ∂</span>
          </div>
          <div class="contact-body">
            ${c.role?`<div class="row"><strong>Roll:</strong> ${escapeHtml(c.role)}</div>`:''}
            ${c.phone?`<div class="row"><strong>Telefon:</strong> <a href="tel:${String(c.phone).replace(/\s+/g,'')}">${escapeHtml(c.phone)}</a></div>`:''}
            ${c.email?`<div class="row"><strong>E-post:</strong> <a href="mailto:${escapeHtml(c.email)}">${escapeHtml(c.email)}</a></div>`:''}
          </div>`;
        card.querySelector('.contact-head').addEventListener('click',()=>card.classList.toggle('open'));
        box.append(card);
      });
      contactsLoaded=true;
    }
  }catch(e){box.innerHTML='<div style="color:#b00020">Kunde inte l√§sa kontakter.</div>'; }
}

/* ===== Start ===== */
handleRoute();
</script>
</body>
</html>





